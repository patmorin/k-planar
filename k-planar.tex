\documentclass{patmorin}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{pat}
\usepackage{paralist}

\usepackage{tipa}
\usepackage{upgreek}
\usepackage{rotating}
\newcommand{\V}{\rotatebox[origin=c]{180}{$V$}}
\newcommand{\Y}{\rotatebox[origin=c]{180}{$Y$}}
%\usepackage{hyperref}

\setlength{\parskip}{1ex}

\title{\MakeUppercase{Layered $H$-Partitions of $k$-Planar Graphs}%
    \thanks{This work was partly funded by NSERC and MRI.}}

\author{Vida Dujmovi\'c%
        \thanks{School of Computer Science and Electrical Engineering,
                University of Ottawa},\,\,
        Pat Morin%
        \thanks{School of Computer Science, Carleton University},\,\, and
        David R. Wood%
        \thanks{School of Mathematical Sciences, Monash University}}

\newcommand{\dual}[1]{{#1}^\star}
\newcommand{\note}[2]{{\color{red}[#1:~#2]}}

\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\ff}{f}
\newcommand{\f}{{\color{red}\ff}}

\newcommand{\fk}{{\color{red}f(k)}}

\begin{document}
\maketitle


\begin{abstract}
  Layered $H$-partitions of graphs (with small layered width, in which $H$ has small treewidth) are a recently-introduced tool that have been used to solve longstanding problems on queue layouts, non-repetitive colouring, and 3-d graph drawing.  Such partitions are known to exist for planar graphs and, more generally, bounded genus graphs.  In the current paper, we prove that every $k$-planar graph has a layered $H$-partition of layered width $O(k)$ in which $H$ has treewidth $k9^k$. This implies that $k$-planar graphs have both queue number and non-repetitive chromatic number upper-bounded by a function of $k$.
\end{abstract}

\section{Introduction}


\section{$1$-Plane Graphs}

Let $G$ be an edge-maximal 1-plane multigraph graph.  Here, edge-maximal should be taken to mean that, if any two vertices $u$ and $v$ appear on a common face $F$, then there is an edge $uv\in E(G)$ that is contained in the boundary of $F$.

A \emph{kite} in $G$ is the subgraph $K=G[\{v,w,x,y\}]$ induced by the endpoints of a pair of crossing edges $vw,xy\in E(G)$.  It follows from edge-maximality that every kite is isomorphic to the complete graph $K_4$.
The edges $vw$ and $xy$ are called \emph{spars} of $K$.  The cycle $vxwy$ is called the \emph{sail} of $K$.  It follows from edge-maximality that none of the edges $vx$, $xw$, $wy$, or $yv$ are crossed by any other edges of $G$. Thus any edge that is a spar of a kite $K$ is not part of a sail of any kite $K'$. Observe that any spar of $K$ is incident on exactly four \emph{kite faces} of $G$, each of which has three edges and two vertices of $G$ on its boundary.

The 1-plane graph $G$ has a plane triangulation $G'$ as a subgraph that can be obtained by removing one spar from each kite in $G$.  Observe that, for any spar $vw\in E(G)\setminus E(G')$ that crosses $xy\in E(G')$, $G'$ contains the path $vxw$ (and $vyw$).  It follows that $\dist_{G'}(x,y)\le 2\dist_G(x,y)$ for any pair of vertices $x,y\in V(G)$.

\begin{lem}\lemlabel{induction} The setup:
  \begin{compactenum}
    \item Let $G$ and $G'$ be defined as above.
    \item Let $T$ be a BFS tree of $G'$ rooted at some vertex $r$.
    \item For each integer $i\ge 0$, let $V_i=\{v\in V(G):\dist_T(r,v)=i\}$. 
    \item Let $C$ be a cycle in $G'$ with $r$ in the exterior of $C$ and such that
    \begin{compactenum} 
      \item No edge of $C$ is crossed by any edge of $G$; and
      \item $V(C)$ can be partitioned into $P_1,\ldots,P_k$, $k\le 3$ such that for each $i\in\{1,\ldots,k\}$,
      \begin{compactenum}
        \item $C[P_i]$ is a path; and
        \item $|P_i\cap V_j| \le 15$ for all integers $j\ge 0$.
      \end{compactenum}
    \end{compactenum}
    \item Let $N$ and $N'$ be the subgraphs of $G$ and $G'$ consisting only of those edges and vertices contained in $C$ or the interior of $C$.
  \end{compactenum}
  Then $N$ has an $H$-partition $(B_x : x\in V(H))$ such that
  \begin{compactenum}
    \item $H$ is planar;
    \item for all integers $j\ge 0$, and all $x\in V(H)$, $|B_x\cap V_j|\le 15$; 
    \item for each $i\in\{1,\ldots,k\}$, there exists some $x_i\in V(H)$ such that $P_i=B_{x_i}$; and
    \item $H$ has a tree decomposition whose largest bag has size at most 4 and such that some bag contains $x_1,\ldots,x_k$.
  \end{compactenum}
\end{lem}

\begin{proof}
  The proof is by induction on the number of vertices of $N$.
  First note that $N'$ is a near-triangulation.  If $k=3$, set $R_i=P_i$ for each $i\in\{1,2,3\}$.  Otherwise, as before, split $P_1,\ldots,P_k$ to partition $V(C)$ into three sets $R_1$, $R_2$, and $R_3$ such that each $C[R_i]$ is a path and each $R_i$ contains vertices from at most one of $P_1,\ldots,P_k$. 
  
  For each $i\in\{1,2,3\}$ and $v\in R_i$, assign the colour $i$ to $v$.
  For each $v\in V(N')$, consider the path $P_v$ that consists of the subpath of the $v$ to $r$ path in $T$ that stops at the first vertex $v'\in V(C)$. Assign $v$ to have the same colour as $v'$.
  
  Sperner's Lemma ensures that $G'$ contains a triangular face $\tau=v_1v_2v_3$ whose three vertices are assigned different colours. For each $i\in\{1,2,3\}$, let $Q_i=P_{v_i}$ be the path in $T$ form $v_i$ to $v_i'$.  Let $Y$ denote the subgraph of $N'$ consisting of vertices and edges $Q_1$, $Q_2$, $Q_3$, and $\tau$.  Let $Y^+$ denote the subgraph of $N$ consisting of the vertices and edges of $Y$ plus the vertices and edges of every kite formed by a crossing between an edge of $G$ and an edge of $Y$.
  
  We claim that, for each integer $i\ge 0$, $|V(Y^+)\cap V_i|\le 15$.  To see this, first observe that $Y$ contains at most 3 vertices of $V_i$. If a vertex $x\in V(Y^+)\setminus V(Y)$ is contained in $V_i$, then this is because $Y$ contains an edge $vw$ with $v\in V_{i'}$ and $w\in\{V_{i'+1}$ for some $i'\in\{i-1,i\}$ and $G$ contains an edge $xy$ that crosses $vw$. (Recall that $vx,xw\in E(G')$, so $\dist_{G'}(w,r)-1\le\dist_{G'}(x,r)\le\dist_{G'}(v,r)+1$.)  The graph $Y$ contains at most 6 such edges, each of which accounts for at most 2 additional vertices of $V_i$.  Therefore, in total, $|Y^+\cap V_i|\le 15$.

  
  Finally, let $S$ and $S^+$ denote the subgraph of $G$ containing the edges and vertices of $Y$, respectively $Y^+$, and the edges and vertices of $C$.  The graph $S^+$ has some number of bounded faces, all contained in the interior of $C$. Some of the bounded faces of $S$ are kite faces. Call the non-kite bounded faces $F_1,\ldots,F_m$ and let $C_1,\ldots,C_m$ denote their boundaries.  We claim that, for each $i\in\{1,\ldots,m\}$, if some portion of $C_i$ is contained in an edge $vw\in E(G)$ then $vw$ is not crossed by any edge of $G$.  To see this, there are three cases to consider:
  \begin{enumerate}
    \item $vw\in E(C)$. By assumption, $vw$ is not crossed by any edge of $G$.
    \item $vw\in E(Y)$. In this case, the kite containing $vw$ is in $Y^+$, so $vw$ is only incident to kite faces.
    \item $vw\in E(Y^+)\setminus E(Y)$. In this case, either $vw$ is a sail edge in which case it is not crossed by definition, or $vw$ is a spar that was added to $Y^+$ because $vw$ crosses some edge $xy\in E(Y)$.  In this latter case, $vw$ is only incident to kite faces.
  \end{enumerate}
  Therefore each $C_i$ is a cycle in $G^+$ consisting entirely of uncrossed edges. The vertices of $C_i$ can be partitioned into at most three sets $P_1'$, $P_2'$, and $P_3'$ where $P_1'\subset V(Y^+)$, $P_2'\subseteq P_a$ and $P_3'\subseteq P_b$ for some $a,b\in\{1,2,3\}$. Furthermore $C_i[P_j']$ is a path for each $j\in\{1,\ldots,3\}$. Finally, the subgraph $N_i$ of $G$ consisting of the edges and vertices of $G$ contained in $C_i$ or its interior does not contain one of the three vertices of $\tau$. Therefore, we can apply induction using the cycle $C_i$ and the partition $P_1',P_2',P_3'$ of $V(C_i)$ to obtain the desired $H$-partition and tree decomposition of $N_i$.
  
  The remainder of the proof is as before. We use $V(Y^+)\setminus V(C)$ as an element of our $H$-partition.  The root bag in the tree decomposition contains the vertices obtained by contracting each of $P_1,\ldots,P_k$ and $Y^+$.
  
  Planarity comes from the fact that if two edges $vw$ and $xy$ cross, then they end up in the same bag of the $H$-partition.  This means that $H$ is actually obtained by contracting connected sets of vertices in the planar graph $G'$.
\end{proof}

\begin{thm}\thmlabel{1-plane}
  Every 1-plane graph $G$ has a layered $H$-partition of layered width at most 30 where $H$ is planar and has treewidth at most 3.
\end{thm}

\begin{proof}
  The same as before except that the layered width 15 from \lemref{induction} becomes 30 because \lemref{induction} uses a layering of $G'$ and distances in $G'$ can be a factor of 2 larger than in $G$.
\end{proof}

\section{$k$-Planar Graphs}

\subsection{The PS-Tree}

Let $T$ be a rooted tree rooted at $r\in V(T)$. The \emph{depth} of a node $x\in V(T)$ is equal to the length of the path from $x$ to $r$ in $T$. A $P$ path in $T$ is \emph{vertical} if, for each integer $i$, there is at most one vertex of depth $i$.  The deepest vertex in a vertical path $P$ is called  $P$'s \emph{lower endpoint} and the other (shallowest) vertex in $P$ is called $P$'s \emph{upper endpoint}. For any node $v\in T$, we call each node on the path, in $T$, from $v$ to $r$ a \emph{$T$-ancestor} of $v$.

A \emph{near-triangulation} $N$ is a plane graph whose outer face is bounded by a simple cycle in $N$ and each of whose inner faces is bounded by a 3-cycle in $N$.  

Let $\Delta$ be a plane triangulation and let $T$ be a BFS spanning tree of $T$ rooted at some vertex $r$ of degree 3 that is on the outer face of $\Delta$.  For any cycle $F$ of $\Delta$ there is an associated near-triangulation $N=\Delta\circledast F$ consisting of all the edges and vertices of $G$ that are contained in $F$ or its interior.

Let $\tau=v_1v_2v_3$ be an inner face of $N$ and consider the three minimal vertical paths $Q_1$, $Q_2$, and $Q_3$ in $T$ such that, for each $i\in\{1,2,3\}$ the lower endpoint of $Q_i$ is $v_i$ and the upper endpoint of $Q_i$ is in $V(F)$.  If $Q_1$, $Q_2$, and $Q_3$ are vertex disjoint, then the graph $\overline{Y}=\tau\cup Q_1\cup Q_2\cup Q_3$ is called the \emph{closed tripod} in $N$ determined by $\tau$.  We call $Q_1$, $Q_2$, and $Q_3$ the \emph{legs} of $\overline{Y}$ and we call $\tau$ the \emph{center} of $\overline{Y}$.  We call $Y=\overline{Y}-F$ the \emph{(open) tripod} of $N$ determined by $\tau$.  The graph $M=\overline{Y}\cup F$ is called a \emph{Mercedes graph} and the (at most 3) inner faces of $M$ other than $\tau$ are called the \emph{wedges} of $M$.

A \emph{PS-tree}  $K=K(\Delta, T, r)$ is a 3-ary tree, such that each node $x\in V(K)$ is associated with several object (refer to \figref{K-node}):

\begin{figure}
  \begin{center}
    \begin{tabular}{cc}
      \includegraphics{figs/K-node-1} &
      \includegraphics{figs/K-node-2}
    \end{tabular}
  \end{center}
  \caption{The elements associated with a node $x\in V(K)$.}
  \figlabel{K-node}
\end{figure}

\begin{enumerate}
  \item A cycle $F_x$ in $\Delta$ and the near-triangulation $N_x=\Delta\circledast F_x$.
  
  \item An inner face $\tau_x$ of $N_x$ that determines a closed tripod $\overline{Y}_x$ and open tripod $Y_x$ in $N_x$.
  
  \item The \emph{Mercedes graph} $M_x=F_x\cup \overline{Y}_x$
\end{enumerate}

The nodes of the PS-tree $K$ satisfy several conditions:
\begin{compactenum}[(PR1)]
  \item For the root $r'$ of $K$, $F_{r'}$ is defined to be the 3-cycle in $\Delta$ formed by the three vertices adjacent to $r$.
  
  \item \label{children} For each node $x\in V(T)$ such that $M_x$ has $f\le 3$ wedges $F_{x,1},\ldots,F_{x,f}$, the node $x$ has exactly $f$ children $y_1,\ldots,y_f$ in $K$ and $F_{y_i} = F_{x,i}$ for each $i\in\{1,\ldots,f\}$.
  
  \item \label{ancestor-boundary} For each non-root node $x\in V(T)$, there exists a partition of $V(F_x)$ into $g\le 3$ sets $P_1,\ldots,P_g$ such that, for each $i\in\{1,\ldots,g\}$, $F[P_i]$ is a path that is contained in $Y_a$ for some $K$-ancestor $a$ of $x$ \emph{or} $F[P_i]$ is a path in $F_{r'}$.

  \item \label{partition} $\{Y_x : x\in V(K)\}$ is a partition of $V(G^+)\setminus\{r\}$.
  
  \item Something else?
\end{compactenum}

Properties~(PR1)--(PR3) are defining properties of a PS-tree, and they imply the remaining properties. 

% There are at most three ancestors $a$, $b$, and $c$, of $x$ in $T$ such that the vertices of $F_x$ are contained in $V(Y_a)\cup V(Y_b)\cup V(Y_c)$. (See below for the definition of $Y_a$ $Y_b$, and $Y_c$.)
% 
%  consisting of the part of $\Delta$ contained in $F_x$.  Note that $Y_x\subseteq V(N_x)\setminus V(F_x)$ and $V(N_x)\subseteq V(N_a)$ for every ancestor $a$ of $x$.
% 
% {\color{red}Expand the preceding points more fully and point out the relationsships better.  Deal with degenernate cases.}

\subsection{$k$-Planar Graphs}

Let $G$ be a $k$-plane graph and let $G^+$ be the graph obtained by making $G$ planar with dummy vertices, then triangulating the resulting graph and then adding a degree-3 vertex $r$ in the outer face of the resulting graph. Let $T$ be a BFS spanning tree of $G^+$ rooted at $r$. For each integer $i\ge 0$, let $V_i=\{v\in V(G^+): \dist_{G^+}(r,v)=i\}$.  Observe that, for any edge $vw\in E(G)$, $\dist_{G^+}(v,w) \le k$ and therefore, for any two vertices $v,w\in V(G)$,
\begin{equation}
  \dist_{G^+}(v,w) \le k\cdot \dist_G(v,w) \eqlabel{distance-preserving}
\end{equation}

Let $K=K(G^+,T,r)$ be a PS-tree.  We say that a vertex $v\in V(G)$ \emph{appears} at a node $x\in V(K)$ if $v\in Y_x$ or if there exists $vw\in E(G)$ such that $v,w\in V(N_x)$ and $vw$ contains a vertex of $Y_x$, either as an endpoint or in its interior (see \figref{appearances}).

\begin{figure}
  \begin{center}
    \includegraphics{figs/K-node-3}
  \end{center}
  \caption{Examples of vertices (in peach) that appear at a node $x\in V(K)$.}
  \figlabel{appearances}
\end{figure}

Let $S_x$ (the separator at $x$) denote the set of all vertices $v\in V(G)$ such that $v$ appears at $x$ but does not appear at any $K$-ancestor of $x$.  We claim that $(S_x:x\in V(K))$ is a partition of $V(G)$. By (PR\ref{partition}) every vertex $v\in  V(G)$ is in $V(Y_x)\subseteq V(N_x)$. Therefore every vertex $v\in V(G)$ appears at some node $x\in V(K)$, so $\bigcup_{x\in V(K)} S_x \supseteq V(G)$.

Furthermore, if $v$ appears at two nodes $x$ and $y$ then, by definition, $v\in V(N_x)\cap V(N_y)$. If neither $x$ nor $y$ is an ancestor of the other then, by (PR\ref{children}), $V(N_x)\cap V(N_y)=V(F_x)\cap V(F_y)$.  By (PR\ref{ancestor-boundary}), $v\in Y_a$ for some $K$-ancestor $a$ of $x$.  Similarly, $v\in Y_{b}$ for some ancestor $b$ of $y$.  By (PR\ref{partition}), $a=b$ is a common $K$-ancestor of $x$ and $y$.  It follows that there is a unique node $a'$ that is an ancestor of all nodes of $K$ at which $v$ appears, so $v$ appears only in $Y_{a'}$.


% Indeed, if $v$ appears at nodes $x$ and $y$ where neither $x$ nor $y$ is an ancestor of the other, then there exists edges $vw,vz\in E(G)$ (possibly $w=z$) such that $vw$ contains a vertex of $Y_x$ (as an endpoint or in its interior) and $vz$ contains a vertex of $Y_y$ (as endpoint or in its interior).  At least one of these two edges contains a vertex $Y_a$ for some common ancestor $a$ of $x$ and $y$.

We use the partition $(S_x: x\in V(K))$ which generates a graph $H$ with vertex set $V(H)=V(K)$ the edge $xy\in E(H)$ if there exists an edge $vw\in E(G)$ with $v\in S_x$ and $w\in S_y$.
First we argue that this partition has small width with respect to the layering defined by $T$ (note that this is a layering of $G^+$, not a layering of $G$).

\begin{clm}
  For any $x\in V(H)$, and any integer $i\ge 0$, $|S_x\cap V_i|\le 3(k+1)$.
\end{clm}

\begin{proof}
  Done already, several times.
\end{proof}

Next we describe a tree decomposition $(B_x:x\in V(K))$ of $H$.  We deliberately use the same node set $V(H)=V(K)$ here, because the subtree $K[x]:=K[\{z:x\in B_z\}]$ will be rooted at $x$.  We claim that, for every edge $xy\in V(H)$, $x$ is an ancestor of $y$ (or vice-versa).  Suppose that this is not the case and that $xy\in E(H)$ but neither $x$ nor $y$ is an ancestor of the other.  Then, since $xy\in E(H)$, there must exist an edge $vw\in E(G)$ such that $v\in S_x$ and $w\in S_y$.  

Since $v\in S_x$, $v\in V(N_x)$ and similarly $w\in V(N_y)$.  Since neither $x$ nor $y$ are ancestors of each other, the interiors of $F_x$ and $F_y$ are disjoint.  If $v$ is in the interior $V(N_x)\setminus V(F_x)$ of $F_x$ then the edge $vw$ crosses $F_x$ and by (PR\ref{ancestor-boundary}) $v$ appears at some ancestor $a$ of $x$. (The node $a$ is the lowest node for which $v,w\in V(N_a)$.)  But this contradicts the assumption that $v\in S_x$, so it must be that $v\in V(F_x)$. This is also a contradiction, since (PR\ref{ancestor-boundary}) then implies that $v\in Y_a$ and therefore appears at $a$ for some $K$-ancestor $a$ of $x$, which contradicts the assumption that $v\in V(N_x)$.

To describe our tree decomposition we define, for each $x\in V(H)$, the subtree $K[x]=K[\{y:x\in B_y\}]$.  The subtree $K[x]$ contains $x$.  Additionally, for every edge $xz\in E(H)$, where $x$ is an ancestor of $z$, $K[x]$ includes the path from $x$ to $z$ in $K$.  That this produces a tree-decomposition is due to the fact that for every edge $xz$ of $H$, $x$ is an ancestor of $z$ (or vice-versa).  What remains is to upper bound the width of this decomposition.

First observe that, for every $a\in V(K)$, the subtree $K[a]$ is rooted at $a$, i.e., $a$ is a $K$-ancestor of every node in $x\in B_a$.  Now, fix some node $x\in V(K)$ and consider the contents of $B_x$.  As we have just argued, $B_x$ contains only ancestors of $x$ (including $x$ itself). If $B_x$ contains some ancestor $a$ of $x$, it is because there is an edge $vw\in E(G)$ with $v\in S_x$ and $w\in S_a$. Since $v\in S_x$, $v\in V(N_x)$. Since, $w\in S_a$, $w\in Y_a$ or there is an edge $wz\in E(G)$ that contains a point of $Y_a$. The embedding of the path $vwz$ is a curve that being at $v\in N_x$, ends at
$z$, contains a point of $V(Y_a)$ and contains at most $2k+1$ vertices of $G^+$.

Now, consider the cubic graph $A$ homeomorphic to the union of $F_{a'}$ for all ancestors $a'$ of $x$. See \figref{A}.  It is helpful to think of this graph as follows:  We begin with $F_{a_0}$ where $a_0=r'$ is the root of $K$.  We then cut $F_{a_0}$ into two pieces $F^{\bar{x}}_{a_0}$ and $F^x_{a_0}$ where $F^x_{a_0}$ is the piece that contains $F_x$. (The path that makes this cut contains two legs $Q_i$ and $Q_j$ of a tripod $Y$ and one edge $v_iv_j$ of its central triangle $\tau$.)  This process continues by partitioning $F_{a_1}:=F^x_{a_0}$ recursively.  The process terminates after some number $r$ of iterations, when $F^x_{a_r}=F_x$.

\begin{figure}
  \begin{center}
    \includegraphics{figs/A}
  \end{center}
  \caption{The graph $A$.}
  \figlabel{A}
\end{figure}

We claim that the curve $C$ begins in $F_x\subseteq F^x_a\subseteq F_a$, remains in the interior of $F_a$, and eventually reaches the boundary $F^{\bar{x}}_a\cap F^x_a$.  The fact that $C$ remains in $F_a$ is due to the fact that, if it crossed the boundary of $F_a$, then one of $vw$ or $wz$ would intersect $Y_{a'}$ for some ancestor $a'$ of $a$.  If $vw$ intersects $Y_{a'}$, then $v\not\in S_x$.  If $wz$ intersects $Y_{a'}$ then $w,z\not\in S_a$. The fact that $C$ eventually reaches follows from the fact that $w\in Y_a$ or $wz$ contains a point of $Y_a$.

Therefore, to upper-bound $|B_x|$, it suffices to upper-bound the number of faces $F^{\bar{x}}_a$ of $A$ that can be reached with curves that begin in $F_x$, remain in the interior of $F_a$, and terminate in $F^{\bar{x}}_a$ without intersecting more than $2k$ edges in $A$.  To avoid triple subscripts we say that a curve visits $a_i$ if it visits $F^{\bar{x}}_{a_i}$.  We can further restrict ourselves to studying curves that cross the fewest number of edges of $A$ since if a curve exists that crosses at most $k$ edges then the curve that crosses the fewest number of possible edges also crosses at most $k$ edges.  We will call such a curve a \emph{lightest} curve from $x$ to $a$.

Again, we let $a_0,\ldots,a_r$ denote the vertices of the path, in $K$ from the root $a_0$ to $x=a_r$.  We claim that, there exists a lightest curve from $a_r$ to $a_0$ that is monotonic in the sense that the curve visits $a_{i_0},\ldots,a_{i_t}$ in this order, where $i_0=r > i_1>\cdots>i_t=0$.
This follows from (PR\ref{ancestor-boundaries}):  For any node $a_i$, $i>0$, there are at most three faces of $A$ that share a part of their boundary with $F_{a_i}$.  Each of these faces also necessarily shares a part of its boundary with $F^{\bar{x}}_{a_i}$.  Therefore it is never advantageous for a path to go from $a_i$ to $a_j$ for some $j>i$ since the path will eventually have to return to one of these three faces.

At this point we are essentially done.  Any monotonic curve that visits $a_i$ has at most 3 choices for the next face $a_j$ $j<i$ to visit.  Therefore, the number of faces of $A$ that can be reached from $F_x$ by admissible curves that cross $2k$ edges of $A$ is at most $3^{2k}$. Therefore,
\[
   |B_x| \le \sum_{j=0}^2k 9^j = (9^{2k+1}-1)/8 \enspace .
\]

This completes the proof

\begin{thm}
    Every $k$-planar graph $G$ has a $(k9^{2k+1}/8,3k)$-partition.
\end{thm}

\bibliographystyle{plain}
\bibliography{warmup}

\end{document}
