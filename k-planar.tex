\documentclass{patmorin}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{pat}
\usepackage{paralist}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage{tipa}
\usepackage{upgreek}
\usepackage{rotating}
\newcommand{\V}{\rotatebox[origin=c]{180}{$V$}}
\newcommand{\Y}{\rotatebox[origin=c]{180}{$Y$}}
%\usepackage{hyperref}

\setlength{\parskip}{1ex}

\title{\MakeUppercase{Layered $H$-Partitions of $k$-Planar Graphs}%
    \thanks{This work was partly funded by NSERC and MRI.}}

\author{Vida Dujmovi\'c%
        \thanks{School of Computer Science and Electrical Engineering,
                University of Ottawa},\,\,
        Pat Morin%
        \thanks{School of Computer Science, Carleton University},\,\, and
        David R. Wood%
        \thanks{School of Mathematical Sciences, Monash University}}

\newcommand{\dual}[1]{{#1}^\star}
\newcommand{\note}[2]{{\color{red}[#1:~#2]}}

\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\ff}{f}

\renewcommand{\proplabel}[1]{\label{prop:#1}}
\renewcommand{\propref}[1]{(PR\ref{prop:#1})}

\begin{document}
\maketitle


\begin{abstract}
  Layered $H$-partitions of graphs (with small layered width, in which $H$ has small treewidth) are a recently-introduced tool that have been used to solve longstanding problems on queue layouts, non-repetitive colouring, and 3-d graph drawing.  Such partitions are known to exist for planar graphs and, more generally, bounded genus graphs.  In the current paper, we prove that every $k$-planar graph has a layered $H$-partition of layered width $O(k)$ in which $H$ has treewidth $O(c^k)$, for some constant $c$. This implies that $k$-planar graphs have both queue number and non-repetitive chromatic number upper-bounded by a function of $k$.
\end{abstract}

\section{Introduction}

A \emph{layering} of a graph $G$ is a partition $\mathcal{L}=\{V_0,V_1,\ldots,V_h\}$ of $V(G)$ so that there is no edge $vw\in E(G)$ such that $v\in V_i$, $w\in V_j$ and $|j-i|>1$.  For any partition $\mathcal{P}=\{S_1,\ldots,S_p$ of $V(G)\}$, the \emph{quotient graph} $H=G/\mathcal{P}$ has $V(H)=\{x_1,\ldots,x_p\}$ and $x_ix_j\in E(H)$ if and only there exists an edge $vw\in E(G)$ such that $v\in S_i$ and $w\in S_j$.  
% We call $\mathcal{P}$ an \emph{$H$-partition} of $G$ and we write this concisely as $\mathcal{P}=\{S_x : x\in V(H)\}$ so that each element of $\mathcal{P}$ is indexed by the vertex it creates in $H$.
A layered $H$-partition $(\mathcal{L},\mathcal{P})$ of a graph $G$ consists of a layering $\mathcal{L}$ of $G$ and an $H$-partition $\mathcal{P}$ of $G$. The \emph{layered width} of $(\mathcal{H},\mathcal{P})$ is $\max\{|L\cap P|: L\in\mathcal{L},\, P\in\mathcal{P}\}$.

Layered $H$-partition of small layered width in which $H$ has some additional property are a useful tool for a number of graph problems. \citet{dujmovic.joret.ea:planar} show that, if each graph $G$ in some family $\mathcal{G}$ of graphs has a layered $H$-partition for which the layered-width and the treewidth of $H$ are each upper-bounded by some constant $c_\mathcal{G}$, then each of the following quantities are upper bounded by a constant, for every $G\in\mathcal{G}$: queue number \cite{X}, track number \cite{X}, etc \cite{X}, etc \cite{X}, etc \cite{X}. \citet{dujmovic.esperet.ea:planar} add non-repetitive chromatic number to this list.  \citet{dujmovic.joret.ea:planar} show that two common families of graphs have such $H$-partitions: planar graphs and (more generally) bounded-genus graphs.

In this paper we show that another family of graphs admits layered $H$-partitions of constant layered-width in which $H$ has constant treewidth: $k$-planar graphs. An \emph{embedded graph} $G$ is a graph with $V(G)\subset\R^2$ in which each edge $vw\in E(G)$ is a closed curve\footnote{A closed curve is a continuous function $f:[0,1]\to \R^2$. The points $f(0)$ and $f(1)$ are called the \emph{endpoints} of the curve.  When there is no danger of misunderstanding we treat a curve $f$ as a point set $\{f(t):0\le t\le 1\}$.} with endpoints $v$ and $w$ and not containing any vertex of $G$ in its interior.  A \emph{crossing} in an embedded graph $G$ is a triple $(p,vw,xy)$ with $p\in\R^2$, $vw,xy\in E(G)$ and such that $p\in (vw\cap xy)\setminus\{v,w,x,y\}$. An embedded graph $G$ is \emph{$k$-plane} if each edge of $G$ takes part in at most $k$ crossings.  A (not necessarily embedded) graph $G'$ is \emph{$k$-planar} if there exists $k$-plane graph $G$ isomorphic to $G'$.  We prove the following result:

\begin{thm}\thmlabel{k-planar}
  Every $k$-planar graph has a layered $H$-partition of layered-width at most $(k+1)(12k + 9)$ in which $H$ has treewidth at most $(9^{k+1}-3)/2$.
\end{thm}

In the special case $k=1$ we obtain better constants and additional property (planarity) of $H$:

\begin{thm}\thmlabel{1-planar}
  Every 1-planar graph has a layered $H$-partition of layered width at most 30 where $H$ is planar and has treewidth at most 3.
\end{thm}

These results imply that, for any constant $k$, $k$-planar graphs have all the graph parameters mentioned above upper-bounded by some constant $c_k$.

In \secref{1-planar} we prove \thmref{1-planar}.  In \secref{k-planar} we prove \thmref{k-planar}.

\section{$1$-Planar Graphs}
\seclabel{1-planar}

Let $G$ be an edge-maximal 1-plane multigraph.  Here, edge-maximal should be taken to mean that, if any two vertices $u$ and $v$ appear on a common face\footnote{The \emph{faces} of an embedded graph $G$ are the connected components of $\R^2\setminus \bigcup_{vw\in E(G)} vw$.  We say that a vertex $v\in V(G)$ appears on a face $F$ if $v$ is contained in the closure of $F$.} $F$, then there is an edge $uv\in E(G)$ that is contained in the boundary of $F$.

A \emph{kite} in $G$ is the subgraph $K=G[\{v,w,x,y\}]$ induced by the endpoints of a pair of crossing edges $vw,xy\in E(G)$.  It follows from edge-maximality that every kite is isomorphic to the complete graph $K_4$.
The edges $vw$ and $xy$ are called \emph{spars} of $K$.  The cycle $vxwy$ is called the \emph{sail} of $K$.  It follows from edge-maximality that none of the edges $vx$, $xw$, $wy$, or $yv$ are crossed by any other edges of $G$. Thus any edge that is a spar of a kite $K$ is not part of a sail of any kite $K'$. Observe that any spar of $K$ is incident on exactly four \emph{kite faces} of $G$, each of which has three edges and two vertices of $G$ on its boundary.

The 1-plane graph $G$ has a plane triangulation $G'$ as a subgraph that can be obtained by removing one spar from each kite in $G$.  Observe that, for any spar $vw\in E(G)\setminus E(G')$ that crosses $xy\in E(G')$, $G'$ contains the path $vxw$ (and $vyw$).  It follows that $\dist_{G'}(x,y)\le 2\cdot\dist_G(x,y)$ for any pair of vertices $x,y\in V(G)$.

Our proof of \thmref{1-planar} follows quickly from the following technical lemma, which is an extension of Lemma~X in \citet{dujmovic.joret.ea:planar}.
\begin{lem}\lemlabel{induction} The setup:
  \begin{compactenum}
    \item Let $G$ and $G'$ be defined as above.
    \item Let $T$ be a BFS tree of $G'$ rooted at some vertex $r$.
    \item For each integer $i\ge 0$, let $V_i=\{v\in V(G):\dist_T(r,v)=i\}$. 
    \item Let $C$ be a cycle in $G'$ with $r$ in the exterior of $C$ and such that
    \begin{compactenum} 
      \item No edge of $C$ is crossed by any edge of $G$; and
      \item $V(C)$ can be partitioned into $P_1,\ldots,P_k$, $k\le 3$ such that for each $i\in\{1,\ldots,k\}$,
      \begin{compactenum}
        \item $C[P_i]$ is a path; and
        \item $|P_i\cap V_j| \le 15$ for all integers $j\ge 0$.
      \end{compactenum}
    \end{compactenum}
    \item Let $N$ and $N'$ be the subgraphs of $G$ and $G'$ consisting only of those edges and vertices contained in $C$ or the interior of $C$.
  \end{compactenum}
  Then $N$ has an $H$-partition $(B_x : x\in V(H))$ such that
  \begin{compactenum}
    \item $H$ is planar;
    \item for all integers $j\ge 0$, and all $x\in V(H)$, $|B_x\cap V_j|\le 15$; 
    \item for each $i\in\{1,\ldots,k\}$, there exists some $x_i\in V(H)$ such that $P_i=B_{x_i}$; and
    \item $H$ has a tree decomposition whose largest bag has size at most 4 and such that some bag contains $x_1,\ldots,x_k$.
  \end{compactenum}
\end{lem}

\begin{proof}
  The proof is by induction on the number of vertices of $N$.
  First note that $N'$ is a near-triangulation.  If $k=3$, set $R_i=P_i$ for each $i\in\{1,2,3\}$.  Otherwise, as before, split $P_1,\ldots,P_k$ to partition $V(C)$ into three sets $R_1$, $R_2$, and $R_3$ such that each $C[R_i]$ is a path and each $R_i$ contains vertices from at most one of $P_1,\ldots,P_k$. 
  
  For each $i\in\{1,2,3\}$ and $v\in R_i$, assign the colour $i$ to $v$.
  For each $v\in V(N')$, consider the path $P_v$ that consists of the subpath of the $v$ to $r$ path in $T$ that stops at the first vertex $v'\in V(C)$. Assign $v$ to have the same colour as $v'$.
  
  Sperner's Lemma ensures that $G'$ contains a triangular face $\tau=v_1v_2v_3$ whose three vertices are assigned different colours. For each $i\in\{1,2,3\}$, let $Q_i=P_{v_i}$ be the path in $T$ form $v_i$ to $v_i'$.  Let $Y$ denote the subgraph of $N'$ consisting of vertices and edges $Q_1$, $Q_2$, $Q_3$, and $\tau$.  Let $Y^+$ denote the subgraph of $N$ consisting of the vertices and edges of $Y$ plus the vertices and edges of every kite formed by a crossing between an edge of $G$ and an edge of $Y$.
  
  We claim that, for each integer $i\ge 0$, $|V(Y^+)\cap V_i|\le 15$.  To see this, first observe that $Y$ contains at most 3 vertices of $V_i$. If a vertex $x\in V(Y^+)\setminus V(Y)$ is contained in $V_i$, then this is because $Y$ contains an edge $vw$ with $v\in V_{i'}$ and $w\in\{V_{i'+1}$ for some $i'\in\{i-1,i\}$ and $G$ contains an edge $xy$ that crosses $vw$. (Recall that $vx,xw\in E(G')$, so $\dist_{G'}(w,r)-1\le\dist_{G'}(x,r)\le\dist_{G'}(v,r)+1$.)  The graph $Y$ contains at most 6 such edges, each of which accounts for at most 2 additional vertices of $V_i$.  Therefore, in total, $|Y^+\cap V_i|\le 15$.

  
  Finally, let $S$ and $S^+$ denote the subgraph of $G$ containing the edges and vertices of $Y$, respectively $Y^+$, and the edges and vertices of $C$.  The graph $S^+$ has some number of bounded faces, all contained in the interior of $C$. Some of the bounded faces of $S$ are kite faces. Call the non-kite bounded faces $F_1,\ldots,F_m$ and let $C_1,\ldots,C_m$ denote their boundaries.  We claim that, for each $i\in\{1,\ldots,m\}$, if some portion of $C_i$ is contained in an edge $vw\in E(G)$ then $vw$ is not crossed by any edge of $G$.  To see this, there are three cases to consider:
  \begin{enumerate}
    \item $vw\in E(C)$. By assumption, $vw$ is not crossed by any edge of $G$.
    \item $vw\in E(Y)$. In this case, the kite containing $vw$ is in $Y^+$, so $vw$ is only incident to kite faces.
    \item $vw\in E(Y^+)\setminus E(Y)$. In this case, either $vw$ is a sail edge in which case it is not crossed by definition, or $vw$ is a spar that was added to $Y^+$ because $vw$ crosses some edge $xy\in E(Y)$.  In this latter case, $vw$ is only incident to kite faces.
  \end{enumerate}
  Therefore each $C_i$ is a cycle in $G^+$ consisting entirely of uncrossed edges. The vertices of $C_i$ can be partitioned into at most three sets $P_1'$, $P_2'$, and $P_3'$ where $P_1'\subset V(Y^+)$, $P_2'\subseteq P_a$ and $P_3'\subseteq P_b$ for some $a,b\in\{1,2,3\}$. Furthermore $C_i[P_j']$ is a path for each $j\in\{1,\ldots,3\}$. Finally, the subgraph $N_i$ of $G$ consisting of the edges and vertices of $G$ contained in $C_i$ or its interior does not contain one of the three vertices of $\tau$. Therefore, we can apply induction using the cycle $C_i$ and the partition $P_1',P_2',P_3'$ of $V(C_i)$ to obtain the desired $H$-partition and tree decomposition of $N_i$.
  
  The remainder of the proof finishes in the same way as the proof of Lemma~X in \cite{dujmovic.joret.ea:planar}.  $P_1,\ldots,P_k$, and $V(Y^+)\setminus V(C)$ become elements of the $H$-partition.  Elements in each of the $H$-partitions of $N_1,\ldots,N_3$ that intersect $P_1,\ldots,P_k$, or $V(Y^+)\setminus V(C)$ are discarded and all the resulting sets are combined to obtain an $H$-partition of $G$.  The desired tree decomposition of $G$ is obtained in exactly the same way as in the proof of Lemma~X in blah.
  
  The planarity of $H$ comes from the fact that if two edges $vw$ and $xy$ cross, then they end up in the same bag of the $H$-partition.  This means that $H$ is actually obtained by contracting connected sets of vertices in the planar graph $G'$.  It is well know that any graph obtained by contracting connected sets of vertices in a planar graph is also planar.
\end{proof}


\begin{proof}[Proof of \thmref{1-plane}]
  The same as before except that the layered width 15 from \lemref{induction} becomes 30 because \lemref{induction} uses a layering of $G'$ and distances in $G'$ can be a factor of 2 larger than in $G$.
\end{proof}

\section{$k$-Planar Graphs}

\subsection{PS-Trees}

Let $T$ be a rooted tree rooted at $r\in V(T)$. The \emph{depth} of a node $x\in V(T)$ is equal to the length of the path from $x$ to $r$ in $T$. A $P$ path in $T$ is \emph{vertical} if, for each integer $i$, $P$ contains at most one vertex of depth $i$.  The deepest vertex in a vertical path $P$ is called  $P$'s \emph{lower endpoint} and the other (shallowest) vertex in $P$ is called $P$'s \emph{upper endpoint}. For any node $v\in T$, we call each node on the path, in $T$, from $v$ to $r$ a \emph{$T$-ancestor} of $v$.

A \emph{near-triangulation} $N$ is a plane graph whose outer face is bounded by a simple cycle in $N$ and each of whose inner faces is bounded by a 3-cycle in $N$.  

Let $\Delta$ be a plane triangulation and let $T$ be a BFS spanning tree of $\Delta$ rooted at some vertex $r$ of degree 3 that is on the outer face of $\Delta$.  For any cycle $F$ of $\Delta$ there is an associated near-triangulation $N=\Delta\circledast F$ consisting of all the edges and vertices of $G$ that are contained in $F$ or its interior.

Let $\tau=v_1v_2v_3$ be an inner face of $N$ and consider the three minimal vertical paths $Q_1$, $Q_2$, and $Q_3$ in $T$ such that, for each $i\in\{1,2,3\}$ the lower endpoint of $Q_i$ is $v_i$ and the upper endpoint of $Q_i$ is in $V(F)$.  If $Q_1$, $Q_2$, and $Q_3$ are vertex disjoint, then the graph $\overline{Y}=\tau\cup Q_1\cup Q_2\cup Q_3$ is called the \emph{closed tripod} in $N$ determined by $\tau$.  We call $Q_1$, $Q_2$, and $Q_3$ the \emph{legs} of $\overline{Y}$ and we call $\tau$ the \emph{center} of $\overline{Y}$.  We call $Y=\overline{Y}-F$ the \emph{(open) tripod} of $N$ determined by $\tau$.  The graph $M=\overline{Y}\cup F$ is called a \emph{Mercedes graph} and the (at most 3) inner faces of $M$ other than $\tau$ are called the \emph{wedges} of $M$.

A \emph{PS-tree}  $K=K(\Delta, T, r)$ is a 3-ary tree, such that each node $x\in V(K)$ is associated with several object (refer to \figref{K-node}):

\begin{figure}
  \begin{center}
    \begin{tabular}{cc}
      \includegraphics{figs/K-node-1} &
      \includegraphics{figs/K-node-2}
    \end{tabular}
  \end{center}
  \caption{The elements associated with a node $x\in V(K)$.}
  \figlabel{K-node}
\end{figure}

\begin{enumerate}
  \item A cycle $F_x$ in $\Delta$ and the near-triangulation $N_x=\Delta\circledast F_x$.
  
  \item An inner face $\tau_x$ of $N_x$ that determines a closed tripod $\overline{Y}_x$ and an open tripod $Y_x$ in $N_x$.
  
  \item The \emph{Mercedes graph} $M_x=F_x\cup \overline{Y}_x$
\end{enumerate}

The nodes of the PS-tree $K$ satisfy several conditions:
\begin{enumerate}[(PR1)]
  \item For the root $r'$ of $K$, $F_{r'}$ is defined to be the 3-cycle in $\Delta$ formed by the three vertices adjacent to $r$.
  
  \item \proplabel{children} For each node $x\in V(T)$ such that $M_x$ has $f\le 3$ wedges $F_{x,1},\ldots,F_{x,f}$, the node $x$ has exactly $f$ children $y_1,\ldots,y_f$ in $K$ and $F_{y_i} = F_{x,i}$ for each $i\in\{1,\ldots,f\}$.
  
  \item \proplabel{ancestor-boundary} For each non-root node $x\in V(T)$, there exists a partition of $V(F_x)$ into $g\le 3$ sets $P_1,\ldots,P_g$ such that, for each $i\in\{1,\ldots,g\}$, $F[P_i]$ is a path that is contained in $Y_a$ for some $K$-ancestor $a$ of $x$ \emph{or} $F[P_i]$ is a path or cycle in $F_{r'}$.

  \item \proplabel{partition} $\{Y_x : x\in V(K)\}$ is a partition of $V(G^+)\setminus\{r\}\setminus V(F_{r'})$.
\end{enumerate}

For any triangulation $\Delta$ in which the outer face has a vertex $r$ of degree 3 and for any BFS spanning-tree of $\Delta$ rooted at $r$, there exists a PS-tree $K=K(\Delta,T,r)$.  Indeed, this tree is constructed (albeit implicitly) by \citet[Proof of Lemma~X]{dujmovic.joret.ea:planar}.

The following property of a PS-Tree $K$ is an immediate consequence of \propref{children} that will be useful for us:
\begin{compactenum}[(PR5)]
  \item \proplabel{ancestors} If $v\in V(N_x-F_x)$ and $w\in V(N_y-N_y)$ for some nodes $x,y\in V(K)$, then one of $x$ or $y$ is a $K$-ancestor of the other.
\end{compactenum}


\subsection{$k$-Planar Graphs}

Let $G$ be a $k$-plane graph and let $G^+$ be the graph obtained as follows:
\begin{compactenum}
  \item Make $G$ planar by adding dummy vertices at each crossing to obtain a graph $G_1$.
  \item Add a $K_4$ that contains $G_1$ in one of its inner faces $F_0$ to obtaina graph $G_2$.
  \item Add edges to complete $G_2$ to a triangulation $G^+$.
\end{compactenum}
Let $r$ be the vertex of the $K_4$ not incident on $F_0$ and let $T$ be a BFS spanning tree of $G^+$ rooted at $r$.    Observe that, for any edge $vw\in E(G)$, $\dist_{G^+}(v,w) \le k+1$ and therefore, for any two vertices $v,w\in V(G)$,
\begin{equation} 
  \dist_{G^+}(v,w) \le (k+1)\cdot \dist_G(v,w) \eqlabel{distance-preserving}
\end{equation}
For each integer $i\ge 0$, let $V_i=\{v\in V(G^+): \dist_{G^+}(r,v)=i\}$ and observe that $V_0,V_1,\ldots,V_{t}$ is a layering of $G^+$ (but not of $G$).

Let $K=K(G^+,T,r)$ be a PS-tree and observe that the root $r'$ of $K$ has $F_{r'}=F_0$.  This implies:
\begin{compactenum}[(PR6)]
  \item \proplabel{all-in}  $V(G_1)\subseteq V(N_{r'}-F_{r'})$.
\end{compactenum}

For each vertex $v\in V(G_1)$, let $P_v=\{a\in V(K): v\in V(N_a-F_a)\}$.  
By (PR6), $P_{v}$ contains the root $r'$ of $K$.  By \propref{children}, any node $a\in P_{v}$ has at most one child in $P_{v}$ and any node $a\not\in P_{v}$ has no child in $P_{v}$.  It follows that $K[P_{v}]$ is a vertical path in $K$ that contains the root.  

For each edge $vw\in E(G)$, consider the walk $W_{vw}$ in $G^+$ that corresponds to $vw$ and define $A_{vw}=\bigcap_{z\in W_{vw}} P_z$.  Since $W_{vw}\subseteq V(G_1)$, $A_{vw}$ is well-defined.  For each $z\in W_{vw}$, $P_{z}$ contains $r'$ and is a vertical path in $K$.  The common intersection of two or more vertical paths is a vertical path.  Therefore $A_{vw}$ is a non-empty vertical path in $K$.  For any vertex $v\in V(G)$ define $A_v=\bigcap_{vw\in E(G)} A_{vw}$.  Again, $K[A_v]$ is a vertical path in $K$ that contains $r'$.  We define $a(v)$ to be the lower endpoint of $K[A_v]$.

For every node $x\in V(K)$, define the \emph{separator}
\[
   S_x = \{v\in V(G): a(v)=x \} \enspace .
\]
Clearly $\mathcal{S}=\{S_x:x\in V(K)\}$ is a partition of $V(G)$.

Consider graph $H=G/\mathcal{S}$ that has vertex set $V(H)=V(K)$ and the edge $xy\in E(H)$ if and only if there exists an edge $vw\in E(G)$ with $v\in S_x$ and $w\in S_y$.  First we argue that this partition has small width with respect to the layering defined by $T$ (recall that this is a layering of $G^+$, not a layering of $G$).

\begin{clm}
  For any $x\in V(H)$, and any integer $i\ge 0$, $|S_x\cap V_i|\le 3(4k+3)$.
\end{clm}

\begin{proof}
  Since the vertices of $Y_x$ come from at most 3 vertical paths in $T$, $|V(Y_x)\cap V_i|\le 3$.  Any vertex $v\in S_x\cap V_i$ is either in $V(Y_x)$ or is an endpoint of an edge $vw\in E(G)$ that contains a vertex $v'\in V(Y_x)$.  In the latter case, $|\dist_T(r,v)-\dist_T(r, v')|\le k+1$.  Therefore $v'\in V(Y_x)\cap V_{j}$ for some $j\in\{i-k-1,\ldots,i+k+1\}$.   Any such $v'$ is responsible for at most 2 vertices in $S_x\setminus V(Y_x)$. Therefore,
  \[  |S_x\cap V_i| \le |V(Y_x)\cap V_i| + 3\cdot 2\cdot (2k+1) \le 12k+9 \enspace . \qedhere \]
\end{proof}

Next we describe a tree decomposition $(B_x:x\in V(K))$ of $H$.  We deliberately use the same node set $V(H)=V(K)$ here, because the subtree $K[x]:=K[\{z:x\in B_z\}]$ will be rooted at $x$.  

\begin{clm}\clmlabel{xy-ancestor}
   For every edge $xy\in V(H)$, one of $x$ or $y$ is a $K$-ancestor of the other.
 \end{clm}
 
 \begin{proof}
   Since $xy\in E(H)$, there exists an edge $vw\in E(G)$ such that $v\in S_x$ and $w\in S_y$.  By definition, $x\in P_v\subseteq A_{vw}$ and $y\in P_w\subseteq A_{vw}$.  Since $K[A_{vw}]$ is a vertical path in $K$, it follows that one of $x$ or $y$ is a $K$-ancestor of the other. 
\end{proof}

The tree decomposition $(B_x:x\in V(K))$ of $H$ is defined as follows: For each edge $xy$ where $y$ is a $K$-ancestor of $x$, we add $y$ to be $B_{x'}$ for every node $x'$ on the path from $x$ to $y$ in $K$.  That this produces a tree-decomposition is due to \clmref{xy-ancestor}.  What remains is to upper bound the width of this decomposition.

\begin{clm}
  The tree decomposition $\{B_x: x\in V(K)\}$ of $H$ contains no bag larger than BLAH.
\end{clm}

\begin{proof}
  Fix some node $x\in V(K)$ and consider the contents of $B_x$.  By \clmref{xy-ancestor}, $B_x$ contains only $K$-ancestors of $x$ (including $x$ itself). If $B_x$ contains some $K$-ancestor $y$ of $x$, it is because there is an edge $vw\in E(G)$ with $v\in S_x$ and $w\in S_y$.   

  Consider the graph $A$ that contains $F_{a}$ for all $K$-ancestors $a$ of $x$. See \figref{A}.  It is helpful to think of this graph as follows:  We begin with $F_{a_0}$ where $a_0=r'$ is the root of $K$.  We then cut $F_{a_0}$ into two pieces $F^{\bar{x}}_{a_0}$ and $F^x_{a_0}$ where $F^x_{a_0}$ is the piece that contains $F_x$. (The path that makes this cut contains two legs $Q_i$ and $Q_j$ of a tripod $Y$ and one edge $v_iv_j$ of its central triangle $\tau$.)  This process continues by partitioning $F_{a_1}:=F^x_{a_0}$ recursively.  The process terminates after some number $r$ of iterations, when $F^x_{a_r}=F_x$.

  \begin{figure}
    \begin{center}
        \includegraphics{figs/A-1}
    \end{center}
    \caption{The graph $A$.}
    \figlabel{A}
  \end{figure}

  The edge $vw$ corresponds to a walk $W_{vw}=v_0,v_1,\ldots,v_{\ell}$ in $G^+$ that
  (i)~begins at $v_0=v\in V(N_x-F_x)$, (ii)~contains only vertices in $V(N_y-F_y)$, (iii)~ends at $w\in V(N_y)$, \note{PM:notation!} (iv)~has length $\ell\le k+1$.
  \begin{compactenum}[(i)]
    \item $v\in V(N_x-F_x)$ since $x\in P_v$ and $v\in V(N_a-F_a)$ for all $a\in P_v$;
    
    \item $v_0,v_1,\ldots,v_{\ell}\in V(N_y-F_y)$ since, otherwise there exists some $i\in\{1,\ldots,v_k\}$ such that $v_i\not\in V(N_y-F_y)$.  But this implies that $y\not\in P_{v_i}$ which implies that $y\not\in A_{vw}$ which implies that $y\not\in A_w$, a contradiction.

    \item That $V_{wv}$ contains a vertex $w'\in F^\bar{x}_{y}$ is due to the fact that $y\in P_w$ 
    
    
    and $w\in V(N_y)$.
    
    
    That $vz'$ eventually reaches $F^{\bar{x}}_a$ follows from the fact that, in either case (a) or (b), $vz$ contains a vertex of $Y_a$.  The first such vertex encountered walk walking along $vz$ is the endpoint $z'$.
    
    \item That $\ell\le k+1$ follows from the fact that $G$ is $k$-planar and that each of $v_1,\ldots,v_{\ell-1}$ corresponds to a crossing involving $vw$.  Therefore $\ell-1\le k$.
  \end{compactenum}
  We call any curve with properties (i)--(iv) an \emph{admissible $xa$-curve} (for $A$).  Therefore, to upper-bound $|B_x|$, it suffices to upper-bound the number of faces $F^{\bar{x}}_a$ of $A$ such that there exists an admissible $xa$-curve. To avoid triple-subscripts, we will say that an $xa$-curve \emph{visits} $y\in N(K)$ if it contains a vertex of $F^{\bar{x}}_y$.  It is furthermore sufficient to consider $xa$-curves that are \emph{minimal} in the sense that, if the curve visits $x=x_0,x_1,\ldots,x_\ell=a$ in this order, then $x_i\neq a$ for any $i\in\{0,\ldots,\ell-1\}$.

  By \propref{ancestor-boundary}, for every $y\in V(K)$, there are $t\le 3$ $K$-ancestors $y_1,\ldots,y_t$ of $y$ such that $F_y$ has a vertex in common with $F^{\bar{x}}_{y_i}$. For each $i\in\{1,\ldots,t\}$, colour the pair $(y,y_i)$ with the colour $c(y,y_i)=i$. In this way any pair that receives a colour receives one of 3 colours.  The set $y_1,\ldots,y_t$ behaves like a cutset in the following sense:  If a minimal admissible $xa$-curve visits $y$ (so it contains a point in $F^{\bar{x}}_y$) for some $K$-ancestor $y\neq a$ of $x$, then the curve must subsequently visit one of $y_1,\ldots,y_t$.

  \begin{figure}
    \begin{center}
        \includegraphics{figs/A-2}
    \end{center}
    \caption{The colour sequences defined by two minimal admissible $xa$-curves.}
    \figlabel{colouring}
  \end{figure}

  Consider some minimal admissible $xa$-curve that visits $x=x_0,x_1,\ldots,x_\ell=a$ in this order.  Refer to \figref{colouring}.  Let $z_0,\ldots,z_{\ell'}$ be the subsequence of $x_0,\ldots,x_\ell$ consisting only of those $x_i$ that are strict $K$-ancestors of each of $x_0,\ldots,x_{i-1}$.  This yields a colour sequence $c_1,\ldots,c_{\ell'}$, $\ell'\le \ell$, where $c_i=c(z_{i-1},z_i)$ for each $i\in\{1,\ldots,\ell'\}$.   There are at most $3^{\ell'}$ such colour sequences and, if an admissible $xa$-curve has the same colour sequence as a minimal admissible $xa'$-curve then $a=a'$.  Therefore, for some fixed $x\in V(K)$, the $K$-ancestors $a$ of $x$ such that there exists a minimal admissible $xa$-curve is at most
  \begin{equation}
     |B_x| \le \sum_{\ell=0}^{2k+1} 3^\ell = (3^{2k+2}-1)/2 
         = (9^{k+1}-1)/2 \enspace .  \eqlabel{bag-size}
  \end{equation}
\end{proof}
This is all we need to complete the proof of:


\begin{proof}
  By \eqref{bag-size}, the partition $(S_x:x\in V(K))$ of $G$ described above produces a graph $H$ of treewidth $(9^{k+1}-3)/2$.  For each $x\in V(H)$ and each integer $i$, $|B_x\cap V_i|\le 12k+9$. \Eqref{distance-preserving} implies that setting $V_i' = V_{(k+1)i}\cup\cdots\cup V_{(k+1)(i+1)-1}$ yields a layering $(V_0',V_1',\ldots)$ of  $G$ and $|B_x\cap V_i'|\le (k+1)(12k+9)$ for all integers $i\ge 0$ and all $x\in V(H)$.
\end{proof}

\bibliographystyle{plainnat}
\bibliography{k-planar}

\end{document}
