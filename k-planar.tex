\documentclass{patmorin}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{pat}
\usepackage{paralist}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

% \usepackage{tipa}
% \usepackage{upgreek}
% \usepackage{rotating}
% \newcommand{\V}{\rotatebox[origin=c]{180}{$V$}}
% \newcommand{\Y}{\rotatebox[origin=c]{180}{$Y$}}
%\usepackage{hyperref}

\setlength{\parskip}{1ex}

\title{\MakeUppercase{Layered $H$-Partitions of $k$-Planar Graphs}%
    \thanks{This work was partly funded by NSERC and MRI.}}

\author{Vida Dujmovi\'c%
        \thanks{School of Computer Science and Electrical Engineering,
                University of Ottawa},\,\,
        Pat Morin%
        \thanks{School of Computer Science, Carleton University},\,\, and
        David R. Wood%
        \thanks{School of Mathematical Sciences, Monash University}}

\newcommand{\dual}[1]{{#1}^\star}
\newcommand{\note}[2]{{\color{red}[#1:~#2]}}

\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\depth}{depth}
\DeclareMathOperator{\ff}{f}

\renewcommand{\proplabel}[1]{\label{prop:#1}}
\renewcommand{\propref}[1]{(PR\ref{prop:#1})}

\begin{document}
\maketitle


\begin{abstract}
  Layered $H$-partitions of graphs (with small layered width, in which $H$ has small treewidth) are a recently-introduced tool that have been used to solve longstanding problems on queue layouts, non-repetitive colouring, and 3-d graph drawing.  Such partitions are known to exist for planar graphs and, more generally, bounded genus graphs.  In the current paper, we prove that every $k$-planar graph has a layered $H$-partition of layered width $O(k^2)$ in which $H$ has treewidth $O(c^k)$, for some constant $c$. This is the first result of this type for a non-minor-closed class of graphs and implies that $k$-planar graphs have both queue number and non-repetitive chromatic number upper-bounded by a function of $k$.  The former result was previously shown using a combination of $H$-partitions for planar graphs with \textit{ad hoc} methods. The latter result is new, for all $k\ge 1$.  These results extend to $(g,k)$-planar graphs, the natural generalization of $k$-planar graphs to to genus-$g$ surfaces (rather than the genus-$0$ plane).
\end{abstract}

\section{Introduction}

A \emph{layering} of a graph $G$ is a sequence $\mathcal{L}=\langle V_0,V_1,\ldots,V_h\rangle$ such that $\{V_0,V_1,\ldots,V_h\}$ is a partition of $V(G)$ and there is no edge $vw\in E(G)$ such that $v\in V_i$, $w\in V_j$ and $|j-i|>1$.  For any partition $\mathcal{P}=\{S_1,\ldots,S_p\}$ of $V(G)$, a \emph{quotient graph} $H=G/\mathcal{P}$ has a $p$-element vertex set $V(H)=\{x_1,\ldots,x_p\}$ and $x_ix_j\in E(H)$ if and only there exists an edge $vw\in E(G)$ such that $v\in S_i$ and $w\in S_j$. To highlight the importance of the quotient graph $H$, we call $\mathcal{P}$ an $H$-partition and write this concisely as $\mathcal{P}=\{S_x : x\in V(H)\}$ so that each element of $\mathcal{P}$ is indexed by the vertex it creates in $H$.\footnote{An alternative definition of a layering of $G$ is an $H$-partition of $G$ where $H$ is a path.}  A layered $H$-partition $(\mathcal{L},\mathcal{P})$ of a graph $G$ consists of a layering $\mathcal{L}$ of $G$ and an $H$-partition $\mathcal{P}$ of $G$. The \emph{layered width} of $(\mathcal{H},\mathcal{P})$ is $\max\{|L\cap P|: L\in\mathcal{L},\, P\in\mathcal{P}\}$.

Layered $H$-partitions of small layered width in which $H$ has some additional property are a useful tool for a number of graph problems. \citet{dujmovic.joret.ea:planar} show that, if each graph $G$ in some family $\mathcal{G}$ of graphs has a layered $H$-partition for which the layered-width of the partition and the treewidth of $H$ are each upper-bounded by some constant $c_\mathcal{G}$, then each of the following quantities are upper bounded by a constant, for every $G\in\mathcal{G}$: queue number, track number, layered treewidth, and 3-D grid drawing volume. \citet{dujmovic.esperet.ea:planar} add non-repetitive chromatic number to this list.  \citet{dujmovic.joret.ea:planar} show that two common families of graphs have such $H$-partitions: planar graphs and (more generally) bounded-genus graphs.

In this paper we show that another family of graphs admits layered $H$-partitions of constant layered-width in which $H$ has constant treewidth: $k$-planar graphs, which we now define. An \emph{embedded graph} $G$ is a graph with $V(G)\subset\R^2$ in which each edge $vw\in E(G)$ is a closed curve\footnote{A closed curve in a surface $S$ is a continuous function $f:[0,1]\to S$. The points $f(0)$ and $f(1)$ are called the \emph{endpoints} of the curve.  When there is no danger of misunderstanding we treat a curve $f$ as a point set $\{f(t):0\le t\le 1\}$.} in $\R^2$ with endpoints $v$ and $w$ and not containing any vertex of $G$ in its interior.  A \emph{crossing} in an embedded graph $G$ is a triple $(p,vw,xy)$ with $p\in\R^2$, $vw,xy\in E(G)$ and such that $p\in (vw\cap xy)\setminus\{v,w,x,y\}$. An embedded graph $G$ is \emph{$k$-plane} if each edge of $G$ takes part in at most $k$ crossings.  A (not necessarily embedded) graph $G'$ is \emph{$k$-planar} if there exists $k$-plane graph $G$ isomorphic to $G'$.  

Under these definitions $0$-planar graphs are exactly planar graphs and $0$-plane graphs are exactly plane graphs. Thus, like genus-$g$ graphs, $k$-planar graphs are a generalization of planar graphs (which are genus-$0$ graphs).  Unlike genus-$g$ graphs, however, the family of $k$-planar graphs is not minor closed. A graph $G'$ obtained from a $k$-planar graph $G$ by edge deletions and edge contractions may or may not be $k$-planar.

We prove the following result:
\begin{thm}\thmlabel{k-planar}
  Every $k$-planar graph has a layered $H$-partition of layered-width at most $24k^2 + 36k + 12$ in which $H$ has treewidth at most $(3^{k+2}-5)/2$.
\end{thm}


In the special case $k=1$ we obtain better constants and an additional property (planarity) of $H$:

\begin{thm}\thmlabel{1-planar}
  Every 1-planar graph has a layered $H$-partition of layered width at most 30 where $H$ is planar and has treewidth at most 3.
\end{thm}

These results imply that, for any constant $k$, $k$-planar graphs have all the graph parameters mentioned above upper-bounded by some constant $c_k$.

Prior to this work, the strongest structural characterization of $k$-planar graphs was in terms of layered treewidth, which we now define.  A \emph{tree-decomposition} $\mathcal{K}$ of a graph $G$ is consists of a tree $K$ and a collection $\mathcal{K}=\{B_x:x\in V(K)\}$ of subsets of $V(G)$ indexed by nodes of $K$ such that (i)~for every $vw\in E(G)$, there exists some $x\in V(K)$ with that $v,w\in B_x$; and (ii)~for every $v\in V(G)$, $K[x] = K[\{y: x\in B_y\}]$ is connected.  A \emph{layered tree-decomposition} $(\mathcal{L},\mathcal{K})$ consists of a layering $\mathcal{L}$ and a tree-decomposition $\mathcal{K}$ of $G$. The layered-width of $(\mathcal{L},\mathcal{K})$ is $\max\{|L\cap B|: L\in \mathcal{L},\, B\in \mathcal{K}\}$.  The \emph{layered treewidth} of $G$ is the minimum layered-width of any layered tree-decomposition of $G$.

\citet{dujmovic.eppstein.ea:structure} show that $k$-planar graphs have layered treewidth $O(k+1)$.  This already implies that several of the graph parameters mentioned above, including queue-number and non-repetitive chromatic number are upper-bounded by $O(k\log n)$ for $n$-vertex $k$-planar graphs. \thmref{k-planar} is a significant strengthening of this characterization. It implies that $k$-planar graphs have layered-treewidth bounded by a function of $k$ and gives upper bounds on queue-number and non-repetitive chromatic number of $n$-vertex $k$-planar graphs that are independent of $n$.

There is a natural generalization of $k$-planar to genus-$g$ surfaces, that we now describe.  A graph $G$ embedded on a surface $S$ is $(S,k)$-plane if no edge of $G$ is involved in more than $k$ crossings.  A (not necessarily embedded) graph $G$ is $(g,k)$-planar if it is isomorphic to some $(S,k)$-plane graph $G'$ where $S$ is a surface with Euler genus $g$.

\begin{thm}\thmlabel{g-k-planar}
  Every $(g,k)$-planar graph has a layered $H$-partition of layered-width at most $\max\{16gk^2 + 24gk + 8g, 24k^2 + 36k + 12\}$ in which $H$ has treewidth at most $(3^{k+2}-3)/2$.
  
  Every $(g,1)$-planar graph has a layered $H$-partition of layered-width at most $\max\{48g, 30\}$ in which $H$ has treewidth at most $4$.  
\end{thm}

The remainder of the paper is organized as follows: In \secref{k-planar} we prove \thmref{k-planar}.  In \secref{1-planar} we prove \thmref{1-planar}.  
In \secref{genus-g} we prove \thmref{g-k-planar}. 

\section{$k$-Planar Graphs}
\seclabel{k-planar}

The purpose of this section is to prove \thmref{k-planar}.  In this section, all graphs are finite, simple, an undirected.  For any graph $G$ and any set $S$ (typically $S\subseteq V(G)$) we use $G[S]$ to denote the graph with vertex set $V(G)\cap S$ and edge set $\{uv\in E(G) : u,v\in S\}$.  We use $G-S$ as a shorthand for $G[V(G)\setminus S]$ and for a graph $G'$, we use $G-G'$ as a shorthand for $G-V(G')$.  We use $G'\subseteq G$ to denote subgraph containment, i.e., $V(G')\subseteq V(G)$ and $E(G')\subseteq E(G)$.

We begin by introducing a structural tool for planar graphs, called a PS-tree, that is implicit in previous work on $H$-partitions of planar graphs \cite{dujmovic.joret.ea:planar}.  We then show how the PS-tree of a planarized version of a $k$-planar graph $G$ can be used to find a layered $H$-partition of $G$ of small layered width in which $H$ has small treewidth. 

\subsection{PS-Trees}

Let $T$ be a rooted tree rooted at some node $r\in V(T)$. The \emph{$T$-depth} of a node $x\in V(T)$ is equal to the length of the path from $x$ to $r$ in $T$. A $P$ path in $T$ is \emph{vertical} if, for each integer $i$, $P$ contains at most one vertex of $T$-depth $i$.  The deepest vertex in a vertical path $P$ is called  $P$'s \emph{lower endpoint} and the shallowest vertex in $P$ is called $P$'s \emph{upper endpoint}. For any node $v\in T$, we call each node on the path, in $T$, from $v$ to $r$ a \emph{$T$-ancestor} of $v$.

A \emph{near-triangulation} $N$ is a plane graph whose outer face, $F$, is bounded by a simple cycle in $N$ and each of whose inner faces is bounded by a 3-cycle in $N$.  A \emph{triangulation} is a near-triangulation whose outer face is bounded by a 3-cycle.  For any cycle $F$ in a near-triangulation $N$ we use $N\circledast F$ to denote the near-triangulation consisting of all the edges and vertices of $G$ that are contained in $F$ or its interior.

For the remainder of this section, $\Delta$ is a triangulation, $r$ is a degree-3 vertex on the outer face of $\Delta$, and $T$ is a BFS spanning tree of $\Delta$ rooted at $r$.

Fix some cycle $F$ in $\Delta$ and let $N=\Delta\circledast F$.
Let $\tau=v_1v_2v_3$ be an inner face of $N$ and consider the three minimal vertical paths $Q_1$, $Q_2$, and $Q_3$ in $T$ such that, for each $i\in\{1,2,3\}$ the lower endpoint of $Q_i$ is $v_i$ and the upper endpoint of $Q_i$ is in $V(F)$.  If $Q_1$, $Q_2$, and $Q_3$ are vertex disjoint, then the graph $\overline{Y}=\tau\cup Q_1\cup Q_2\cup Q_3$ is called the \emph{closed tripod} in $N$ determined by $\tau$.  We call $Q_1$, $Q_2$, and $Q_3$ the \emph{legs} of $\overline{Y}$ and we call $\tau$ the \emph{center} of $\overline{Y}$.  We call $Y=\overline{Y}-F$ the \emph{(open) tripod} of $N$ determined by $\tau$.  The graph $M=\overline{Y}\cup F$ is called a \emph{Mercedes graph} and the (at most 3) inner faces of $M$ other than $\tau$ are called the \emph{wedges} of $M$.

A \emph{PS-tree}  $K=K(\Delta, T, r)$ is a 3-ary tree, such that each non-root node $x\in V(K)$ is associated with several object (refer to \figref{K-node}):

\begin{figure}
  \begin{center}
    \begin{tabular}{cc}
      \includegraphics{figs/K-node-1} &
      \includegraphics{figs/K-node-2}
    \end{tabular}
  \end{center}
  \caption{The elements associated with a node $x\in V(K)$.}
  \figlabel{K-node}
\end{figure}

\begin{enumerate}
  \item A cycle $F_x$ in $\Delta$ and the near-triangulation $N_x=\Delta\circledast F_x$.
  
  \item An inner face $\tau_x$ of $N_x$ that determines a closed tripod $\overline{Y}_x$ and an open tripod $Y_x=\overline{Y}_x-F_x$ in $N_x$.
  
  \item The \emph{Mercedes graph} $M_x=F_x\cup \overline{Y}_x$
\end{enumerate}

The root node $r^0_K$ of $K$ is exceptional.  We define $F_{r^0_K}$ to be the single-vertex graph containing $r$, we define $\overline{Y}_{r^0_K}$ to be the star formed by $r$ and its three neighbours in $\Delta$, and (as usual) $Y_{r^0_K}=\overline{Y}_{r^0_K}-F_{r^0_K}$.  The root node $r^0_K$ has exactly one child $r_K$, that we call the \emph{sub-root} of $K$, for which $F_{r_K}$ is the 3-cycle formed by the neighbours of $r$ in $\Delta$.

The non-root nodes of the PS-tree $K$ (including the sub-root $r_K$) satisfy several conditions:
\begin{enumerate}[(PR1)]
  \item \proplabel{children} For each non-root node $x\in V(K)$ such that $M_x$ has $f\le 3$ wedges $F_{x,1},\ldots,F_{x,f}$, the node $x$ has exactly $f$ children $y_1,\ldots,y_f$ in $K$ and $F_{y_i} = F_{x,i}$ for each $i\in\{1,\ldots,f\}$.
  
  \item \proplabel{ancestor-boundary} For each non-root node $x\in V(T)$, there exists a partition of $V(F_x)$ into $g\le 3$ sets $P_1,\ldots,P_g$ such that, for each $i\in\{1,\ldots,g\}$, $F[P_i]$ is a path that is contained in $Y_a$ for some $K$-ancestor $a$ of $x$. 

  \item \proplabel{partition} $\{Y_x : x\in V(K)\}$ is a partition of $V(\Delta)\setminus\{r\}$.
\end{enumerate}

For any triangulation $\Delta$ in which the outer face has a vertex $r$ of degree 3 and for any BFS spanning-tree of $\Delta$ rooted at $r$, there exists a PS-tree $K=K(\Delta,T,r)$.  Indeed, this tree is constructed (albeit implicitly) by \citet[Proof of Lemma~14]{dujmovic.joret.ea:planar}.

% \subsubsection{Layered $H$-Partitions from PS-Trees}
% \seclabel{k-to-h}
% 
% Before continuing, it is worth pointing out how an $H$-partition of $\Delta-\{r\}$ can be obtained from a PS-tree $K=K(\Delta,T,r)$. (Note: There is nothing new in this section.  This is just an alternative presentation of material from \citet{dujmovic.joret.ea:planar}.) Given $K=K(\Delta,T,r)$, we obtain a layered $H$-partition $(\mathcal{L},\mathcal{P})$ as follows. 
% 
% We use the layering $\mathcal{L}=\{V_0,V_1,\ldots,V_h\}$ where $V_i=\{ v\in V(\Delta)\setminus\{r\}: \dist_{\Delta}(r,v)=i\}$ and $h=\max\{\dist_\Delta(r,v):v\in V(\Delta)\}$.  The fact that $T$ is a BFS tree ensures that $\mathcal{L}$ is, indeed, a layering of $\Delta-\{r\}$.  We use the vertex partition $\mathcal{P}=\{ S_x:=V(Y_x) : x\in V(K)\}$.  \propref{partition} ensures that $\mathcal{P}$ is, indeed a partition of $V(\Delta)-\{r\}$.
% 
% The resulting layered $H$-partition $(\mathcal{L},\mathcal{P})$ has layered width at most 3 because, for each $x\in V(K)$, $S_x$ is made up of vertices from at most 3 vertical paths in $T$.  These are either the three vertices of $Y_{r_k}$ (if $x=r_K$) or the vertices of the open tripod $Y_x$ whose vertices are included in three vertical paths $Q_1,Q_2,Q_3$ that form the legs of the closed tripod $\overline{Y}_x$.  Therefore $|S_x\cap V_i|\le 3$.
% 
% To show that the quotient graph $H=\Delta/\mathcal{P}$ has small treewidth, we produce a tree-decomposition $\mathcal{K}=\{B_x: x\in V(K)\}$ of $H$ using the tree $K$.  For each $x\in V(K)$, the subtree $K[x]=K[\{y:x\in B_y\}]$ contains
% $x$ as well as every node $y$ such that $V(Y_x)\cap V(F_y) \neq\emptyset$.
% It is straightforward to verify that $K[x]$ is connected for each $x\in V(K)$. The fact that $F_x$ is a cycle in $\Delta$ and \propref{ancestor-boundary} ensures that, if $xy\in E(H)$, then one of $x$ or $y$ is a $K$-ancestor of the other. \propref{ancestor-boundary} also implies that, for any node $y\in V(K)$, $|B_y|\le 4$, since $B_y$ contains $y$ and at most 3 $K$-ancestors of $y$.
% 
% Therefore $(\mathcal{L},\mathcal{P})$ is a layered $H$-partition of $\Delta-\{r\}$ with layered-width 3 in which $H$ has treewidth 3.  Furthermore, for each $P\in\mathcal{P}$, $\Delta[P]$ is connected.  Since $\Delta$ is planar, this implies that $H$ is planar.\footnote{It is well-known and easy to see that any graph $\Delta'$ obtained by contracting an edge in a planar graph $\Delta$ is also planar.  Repeatedly applying this fact implies that $\Delta/\mathcal{P}$ is planar provided that $\Delta[P]$ is connected for every $P\in\mathcal{P}$.}

\subsection{$k$-Planar Graphs}

Let $G$ be a $k$-plane graph.  We will assume, for ease of exposition, that any point $p\in\R^2$ is involved in at most one crossing $(p,vw,xy)$ of $G$. This assumption is not critical since it can be enforced by a slight deformation of the edges of $G$ and the resulting (deformed) graph is also $k$-plane.   Consider the following plane graphs:
\begin{compactenum}
  \item Add a dummy vertex at each crossing in $G$ to obtain a plane graph and then add edges to this graph to obtain a triangulation $G^+$.
  
  \item Add a complete graph $K_4$ that contains $G^{+}$ in one of its inner faces, $F_0$, and then add edges to the resulting graph to obtain a triangulation $G^{++}$.
\end{compactenum}
Observe that, for any edge $vw\in E(G)$, 
\begin{equation}  
  \dist_{G^+}(v,w) \le k+1 \enspace ,  \eqlabel{distance-preserving}
\end{equation}
since (the curve) $vw$ contains a sequence $W_{vw}$ of at most $k+2$ vertices of $G^+$ that form a walk from $v$ to $w$ in $G^+$.

Let $r$ be the vertex of the $K_4$ not incident on $F_0$ and let $T$ be a BFS spanning tree of $G^{++}$ rooted at $r$. 
For each integer $i\ge 0$, let $V_i=\{v\in V(G^+): \dist_{T}(r,v)=i\}$ and observe that $\{V_0,V_1,\ldots,V_{h}\}$ is a layering of $G^+$ (but not of $G$).

Let $K=K(G^{++},T,r)$ be a PS-tree and observe that the sub-root $r_K$ of $K$ has $F_{r_K}=F_0$.  This implies:
\begin{compactenum}[(PR1)]\setcounter{enumi}{4}
  \item \proplabel{all-in}  $G^+\subseteq N_{r_K}-F_{r_K}$.
\end{compactenum}

For each vertex $z\in V(G^+)$, let $P_z=\{a\in V(K): z\in V(N_a-F_a)\}$.  
By \propref{all-in}, $P_{z}$ contains the sub-root $r_K$ of $K$.  By \propref{children}, $K[P_z]$ is a vertical path (whose lower endpoint is the unique node $x\in V(K)$ such that $z\in Y_x$). Therefore $K[P_z]$ is a vertical path in $K$ that contains $r_K$.  We are about to repeatedly use the fact that the common intersection of two or more vertical paths is a vertical path. 

For each edge $vw\in E(G)$, consider the walk $W_{vw}$ in $G^+$ that corresponds to the sequence of vertices in $G^+$ encountered while walking along the curve $vw$ from $v$ to $w$. We define $A_{vw}=\bigcap_{z\in W_{vw}} P_z$.  Since $V(W_{vw})\subseteq V(G^+)$, $A_{vw}$ is well-defined.  For each $z\in V(W_{vw})$, $K[P_{z}]$ is a vertical path in $K$ that contains $r_K$.   Therefore $A_{vw}$ is a non-empty vertical path in $K$.  For any vertex $v\in V(G)$ define $A_v=\bigcap_{vw\in E(G)} A_{vw}$.  Again, $K[A_v]$ is a non-empty vertical path in $K$ that contains $r_K$.  We define $a(v)$ to be the lower endpoint of $K[A_v]$.  For every node $x\in V(K)$, define the \emph{separator}
\[
   S_x = \{v\in V(G): a(v)=x \} \enspace .
\]
\note{PM}{We might be able to save a factor of 2 here on the layered width, because we only need one endpoint of each edge $vw$.}Clearly $\mathcal{S}=\{S_x:x\in V(K)\}$ is a partition of $V(G)$.  We will use $\mathcal{S}$ as the partition that defines our quotient graph $H=G/\mathcal{S}$ with vertex set $V(H)=V(K)$ and the edge $xy\in E(H)$ if and only if there exists an edge $vw\in E(G)$ with $v\in S_x$ and $w\in S_y$.  First we argue that this partition has small width with respect to the layering $\{V_0,\ldots,V_h\}$ defined by $T$ (recall that this is a layering of $G^+$, not a layering of $G$).

\begin{clm}\clmlabel{chargeback-to-y}
   For any $x\in V(K)$ and any vertex $v\in S_x$, there exists a vertex $v'\in Y_x$ such that $|\dist_T(r,v')-\dist_T(r,v)|\le k+1$.  
\end{clm}

\begin{proof}
  Since $v\in S_x$, the lower endpoint of $K[A_{vw}]$ is $x$ for some edge $vw\in E(G)$.  This implies that $W_{vw}\subset N_x-F_x$ but $W_{vw} \not\subseteq N_{x'}-F_{x'}$ for any any child $x'$ of $x$ in $K$. Therefore, \propref{children} and \propref{ancestor-boundary} imply that $W_{vw}$ contains a vertex $v'\in Y_x$.  Since $G$ is $k$-planar and $v'\in V(W_{vw})$ this implies that $\dist_{G^+}(v,v') \le k+1$.
  By the triangle inequality,     
  \[
    \dist_{G^+}(r,v') \le \dist_{G^+}(r,v) + \dist_{G^+}(v,v') \le \dist_{G^+}(r,v) + k + 1 \enspace .
  \]
  Similarly, $\dist_{G^+}(r,v) \le \dist_{G^+}(r, v') + k+1$.  Therefore
  $|\dist_{G^+}(r,v)-\dist_{G^+}(r,v')| \le k+1$ which establishes the claim, since $T$ is BFS tree rooted at $r$, so $\dist_{T}(r,z)=\dist_{G^+}(r,z)$ for all $z\in V(G^+)$.
\end{proof}

\begin{clm}\clmlabel{width-of-g-plus}
  For any $x\in V(H)$, and any integer $i\ge 0$, $|S_x\cap V_i|\le 24k+12$.
\end{clm}

\begin{proof}
  Since the vertices of $Y_x$ come from at most 3 vertical paths in $T$, $|V(Y_x)\cap V_i|\le 3$.  \clmref{chargeback-to-y} shows that, for any $v\in S_x\cap V_i$, there exists $v'\in Y_x$ with $\dist_T(v,v')\le k+1$. Therefore, $v'\in V(Y_x)\cap V_{j}$ for some $j\in\{i-k-1,\ldots,i+k+1\}$.  If $v'=v$ (so $v'\in V_i$) then $v'$ contributes only one vertex to $S_x$.  If $v'\neq v$ then $v'\in V(G^+-G)$ is a point where two edges of $G$ cross and $v'$ contributes at most the $4$ endpoints of these edges to $S_x$. In either case every $v'\in V(Y_x)\cap \bigcup_{j=i-k-1}^{i+k+1} V_j$ contributes at most $4$ vertices to $S_x\cap V_i$, so $|S_x\cap V_i|\le 3\times 4\times (2k+1) = 24k+12$.
\end{proof}

Next we describe a tree decomposition $\{B_x:x\in V(K)\}$ of $H$.  We deliberately use the same node set $V(H)=V(K)$ here, because the subtree $K[x]:=K[\{z:x\in B_z\}]$ will be rooted at $x$.  

\begin{clm}\clmlabel{xy-ancestor}
   For every edge $xy\in V(H)$, one of $x$ or $y$ is a $K$-ancestor of the other.
 \end{clm}
 
 \begin{proof}
   Since $xy\in E(H)$, there exists an edge $vw\in E(G)$ such that $v\in S_x$ and $w\in S_y$.  By definition, $x\in A_v\subseteq A_{vw}$ and $y\in A_w\subseteq A_{vw}$.  Since $K[A_{vw}]$ is a vertical path in $K$, it follows that one of $x$ or $y$ is a $K$-ancestor of the other. 
\end{proof}

The tree decomposition $(B_x:x\in V(K))$ of $H$ is defined as follows: For each edge $xy\in E(H)$ where $y$ is a $K$-ancestor of $x$, we add $y$ to $B_{x'}$ for every node $x'$ on the path from $x$ to $y$ in $K$.  That this produces a tree-decomposition is due to \clmref{xy-ancestor}.  What remains is to upper bound the width of this decomposition.

\begin{clm}\clmlabel{bag-size}
  The tree decomposition $\{B_x: x\in V(K)\}$ of $H$ contains no bag larger than $(3^{k+2}-3)/2$.
\end{clm}

\begin{proof}
  Fix some node $x\in V(K)$ and consider the contents of $B_x$.  By \clmref{xy-ancestor}, $B_x$ contains only $K$-ancestors of $x$ (including $x$ itself). 
  
  Consider the graph $A$ that contains the edges and vertices of $F_{a}$ for all $K$-ancestors $a$ of $x$. See \figref{A}(a).  It is helpful to think of this graph as follows:  We begin with $F_{a_0}$ where $a_0=r_K$ is the root of $K$.  We then cut $F_{a_0}$ into two pieces $F^{\bar{x}}_{a_0}$ and $F^x_{a_0}$ where $F^x_{a_0}$ is the piece that contains $F_x$. (The path that makes this cut contains two legs $Q_i$ and $Q_j$ of a tripod $Y$ and one edge $v_iv_j$ of its central triangle $\tau$.)  This process continues by partitioning $F_{a_1}:=F^x_{a_0}$ recursively.  The process terminates after some number $d$ of iterations, when $F^x_{a_{d-1}}=F_x=F_{a_d}$.

  \begin{figure}
    
    \begin{center}
      \begin{tabular}{cc}
        \includegraphics{figs/A-1} &
        \includegraphics{figs/A-3} \\ (a) & (b)
      \end{tabular}
    \end{center}
    \caption{(a)~the graph $A$ and (b)~the walks $W_{vw}$ and $W_{ww'}$ that contain the walk $w=v_0,v_1\ldots,v_{\ell-1},v_\ell=w^*$.}
    \figlabel{A}
  \end{figure}

  Refer to \figref{A}(b)
  If $B_x$ contains some $K$-ancestor $a_i$, $i\in\{0,\ldots,d-1\}$, of $x$, it is because there is an edge $vw\in E(G)$ with $v\in S_x$ and $w\in S_{a_i}$.  The edge $vw$ corresponds to a walk $W_{vw}$ in $G^+$. The walk $W_{vw}$ is contained in $N_x-F_x$, otherwise $x\not\in A_{vw}$ so $x\not\in A_v$, and $a(v)\neq x$, contradicting the fact that $v\in S_x$.
  
  However, $w\in S_{_i}$, so there exists an edge $ww'\in E(G)$ such that   $W_{ww'}$ is contained in $W_{ww'}\subseteq N_{a_i}-F_{a_i}$ but $W_{ww'}\not\subseteq N_{a_{i+1}}-F_{a_{i+1}}$.  Therefore $W_{ww'}$ must contain a first vertex $w^*\in V(F_{a_{i+1}}-F_{a_{i}})\subseteq Y_{a_i}$.

  Summarizing, we have a walk $w=v_0,v_1\ldots,v_{\ell-1},v_\ell=w^*$ in $G^+$ such that
  \begin{compactenum}[(i)]
    \item $v_0\in V(N_x-F_x)$;
    
    \item $v_0,\ldots,v_{\ell-1}\in V(N_{a_{i+1}}-F_{a_{i+1}})$;
    
    \item $v_\ell\in V(F_{a_{i+1}}-F_{a_i})$; and
    
    \item $\ell\le k+1$.
  \end{compactenum}
  We call any walk with properties (i)--(iv) an \emph{$i$-walk}. Therefore, to upper-bound $|B_x|$, it suffices to upper-bound the number of $i\in\{0,\ldots,d-1\}$ such that there exists an $i$-walk.
  
  For each $v'\in V(G^+)$, define
  \[  
      d_{v'}=\max\{j\in\{0,\ldots,d\} : v'\in V(N_{a_j}-F_{a_j})
  \]
  (Intuitively, $d_{v'}$ is the $K$-depth of the lower endpoint of $K[P_{v'}]$ or the $K$-depth ($d$) of $x$, whichever is shallower.)
     
  Let $v_0,\ldots,v_\ell$ be an $i$-walk and consider the subsequence $d_0,\ldots,d_{\ell'}$ of $d_{v_0},\ldots,d_{v_\ell}$ consisting of only $d_{v_0}$ and those (record-breaking) $d_{v_j}$ such that $d_{v_j}<\min\{d_{v_0},\ldots,d_{v_{j-1}}\}$.  Observe that $d_0=d$ and $d_{\ell'}=i$.
  
  By \propref{ancestor-boundary}, for every $j\in\{1,\ldots,d\}$, there is a set $X_{j}$, of at most 3 integers $\alpha < j$ such that every vertex $q\in V(F_{a_j})$ is in $V(Y_{a_{\alpha}})$ for some $\alpha\in X_j$.
  Assign a distinct colour $c(j,\alpha)\in\{1,2,3\}$ for each $\alpha\in X_j$ and do this assignment for each $j\in\{1,\ldots,d\}$.  By definition, for any $j\in\{1,\ldots,d\}$ and any colour $\gamma\in\{1,2,3\}$, there is at most one $\alpha=\alpha(j,\gamma)$ such that $c(j,\alpha)=\gamma$.
  
  Finally, observe that, for every $j\in\{1,\ldots,\ell'\}$,  $c(d_j,d_{j+1})$ is defined.  Refer to \figref{colouring}. Therefore the \emph{colour sequence} $c_0,\ldots,c_{\ell'-1}$ where $c_j=c(d_j,d_{j+1})$ is well defined.  Since $d_0=d$ and $d_{\ell'-1}=i$, from the preceding discussion, we have $\alpha(\cdots (\alpha(\alpha(\alpha(d,c_0),c_1),c_2)\cdots),c_{\ell'-1}) = i$.

  \begin{figure}
    \begin{center}
        \includegraphics{figs/A-2}
    \end{center}
    \caption{The colour sequences defined by two $i$-curves.}
    \figlabel{colouring}
  \end{figure}

  The proof is now almost complete.  Any $i$-walk defines a colour sequence $c_0,\ldots,c_{\ell'}$.  If some $i'$-walk defines the same colour sequence $c_0,\ldots,c_{\ell'}$ then
  \[
        i = (\alpha(\alpha(\alpha(d,c_0),c_1),c_2)\cdots),c_{\ell'-1}) = i' \enspace ,
  \]
  so $i=i'$.  Since there are at most $3^{\ell'}$ colour sequences of length $\ell'$ and $\ell'\le \ell \le k+1$, the number of $i\in\{0,\ldots,d-1\}$ such that there exists an $i$-walk is at most
  \[
     \sum_{\ell=1}^{k+1} 3^\ell = (3^{k+2}-3)/2 \ge |B_x| \eqlabel{bag-size} \enspace . \qedhere
  \]
\end{proof}

\note{PM}{I know the analysis in \clmref{bag-size} is not tight---the base $3$ of the exponent can be reduced.  Is it even exponential though?}
We now have all the parts needed to complete the proof of \thmref{k-planar}.

\begin{proof}
  We use the layered $H$-partition $(\mathcal{L}, \mathcal{S})$, where $\mathcal{S}=\{S_x:x\in V(K)\}$ and $\mathcal{L}=\langle V_i': i=0,1,2\ldots\rangle$ where $V_i' = V_{(k+1)i}\cup\cdots\cup V_{(k+1)(i+1)-1}$.  \Eqref{distance-preserving} shows that $\mathcal{L}$ is indeed a layering of $G$.

  By \clmref{bag-size}, $\mathcal{S}$ produces a graph $H=G/\mathcal{S}$ of treewidth $(3^{k+2}-5)/2$.  By \clmref{width-of-g-plus}, for each $x\in V(H)$ and each integer $i$, $|B_x\cap V_i|\le 24k+12$, so $|B_x\cap V_i'|\le (k+1)(24k + 12) = 24k^2+36k+12$. 
\end{proof}


\noindent
\framebox{
\begin{minipage}{\textwidth}
  \note{DW}{%
    % I think we need to define layered treewidth, and
    % give the result of Dujmovic-Eppstein-Wood that (g,k)-planar graphs
    % have O(gk)  layered treewidth. This is the best previous structural
    % description of k-planar graphs. State that layered partitions are
    % richer than  layered treewidth, and lead to O(1) bounds on non-rep
    % chromatic number and queue-number, instead of O(log n) bounds via
    % layered treewidth.
    I also think we should give explicit upper bounds on non-rep chromatic
    number for k-planar graphs, and also for queue-number (especially if
    they improve the bound in the FOCS / J.ACM paper).

    I think we should think about generalising the new theorem for
    (g,k)-planar graphs.

    We should add corollaries for d-map graphs, since they are $d^2$-planar.
    }
    
    \note{PM}{
    A couple of other things to look into: 
    \begin{compactenum}
      \item $p$-centered colourings
      \item low treewidth colourings
    \end{compactenum}
    }
\end{minipage}
}
\section{$1$-Planar Graphs}
\seclabel{1-planar}

Let $G$ be an edge-maximal 1-plane multigraph.  Here, edge-maximal should be taken to mean that, if any two vertices $v$ and $w$ appear on a common face\footnote{The \emph{faces} of an embedded graph $G$ are the connected components of $\R^2\setminus \bigcup_{vw\in E(G)} vw$.  We say that a vertex $v\in V(G)$ appears on a face $F$ if $v$ is contained in the closure of $F$.} $F$, then there is an edge $vw\in E(G)$ that is contained in the boundary of $F$.

A \emph{kite} in $G$ is the subgraph $K=G[\{v,w,x,y\}]$ induced by the endpoints of a pair of crossing edges $vw,xy\in E(G)$.  It follows from edge-maximality that every kite is isomorphic to the complete graph $K_4$.
The edges $vw$ and $xy$ are called \emph{spars} of $K$.  The cycle $vxwy$ is called the \emph{sail} of $K$.  It follows from edge-maximality that none of the edges $vx$, $xw$, $wy$, or $yv$ are crossed by any other edges of $G$. Thus any edge that is a spar of a kite $K$ is not part of a sail of any kite $K'$. Observe that any spar of $K$ is incident on exactly four \emph{kite faces} of $G$, each of which has three edges and two vertices of $G$ on its boundary.

The 1-plane graph $G$ has a plane triangulation $G'$ as a subgraph that can be obtained by removing one spar from each kite in $G$.  Observe that, for any spar $xy\in E(G-G')$ that crosses $vw\in E(G')$, $G'$ contains the path $vxw$ (and $vyw$).  It follows that 
\begin{equation}
  \dist_{G'}(v,w)\le 2 \enspace . \eqlabel{spar-distance}
\end{equation}

Our proof of \thmref{1-planar} follows quickly from the following technical lemma, which is an extension of the equivalent result for plane graphs \cite{dujmovic.joret.ea:planar}.
\begin{lem}\lemlabel{induction} The setup:
  \begin{compactenum}
    \item Let $G$ and $G'$ be defined as above.
    \item Let $T$ be a BFS tree of $G'$ rooted at some vertex $r$.
    \item For each integer $j\ge 0$, let $V_j=\{v\in V(G):\dist_T(r,v)=j\}$. 
    \item Let $F$ be a cycle in $G'$ with $r$ in the exterior of $F$ and such that
    \begin{compactenum} 
      \item No edge of $F$ is crossed by any edge of $G$; and
      \item $V(F)$ can be partitioned into $P_1,\ldots,P_k$, $k\le 3$ such that for each $i\in\{1,\ldots,k\}$,
      \begin{compactenum}
        \item $F[P_i]$ is a path; and
        \item $|V(P_i)\cap V_j| \le 15$ for all integers $j\ge 0$.
      \end{compactenum}
    \end{compactenum}
    \item Let $N^+$ and $N^-$ be the subgraphs of $G$ and $G'$ consisting only of those edges and vertices contained in $F$ or the interior of $F$.
  \end{compactenum}
  Then $N$ has an $H$-partition $\mathcal{P}=\{S_x : x\in V(H)\}$ such that
  \begin{compactenum}
    \item $H$ is planar;
    \item for all integers $j\ge 0$, and all $x\in V(H)$, $|S_x\cap V_j|\le 15$; 
    \item for each $i\in\{1,\ldots,k\}$, there exists some $x_i\in V(H)$ such that $P_i=S_{x_i}$; and
    \item $H$ has a tree decomposition whose largest bag has size at most 4 and such that some bag contains $x_1,\ldots,x_k$.
  \end{compactenum}
\end{lem}

\begin{proof}
  This proof very similar to the proof of Lemma~14 in \citet{dujmovic.joret.ea:planar}. Rather than duplicate every detail of that proof here, we focus on the differences and refer the reader to the original proof for the remaining details.
  
  The proof is by induction on the number of vertices of $N$.
  First note that $N'$ is a near-triangulation.  If $k=3$, set $R_i=P_i$ for each $i\in\{1,2,3\}$.  Otherwise, as in \citet{dujmovic.joret.ea:planar}, split $P_1,\ldots,P_k$ to partition $V(C)$ into three sets $R_1$, $R_2$, and $R_3$ such that each $F[R_i]$ is a path and each $R_i$ contains vertices from at most one of $P_1,\ldots,P_k$. 
  
  Next, as in \citet{dujmovic.joret.ea:planar}, use Sperner's Lemma to find an inner face $\tau=v_1v_2v_3$ of $N'$ such that, $T$ contains disjoint vertical paths $Q_1,Q_2,Q_3$ such that each $Q_i$ begins at $v_i$, ends at some vertex in $R_i$, and whose internal vertices (if any) are contained in $V(N'-F)$.
  
  Let $\overline{Y}$ denote the subgraph of $N'$ consisting of vertices and edges of $Q_1$, $Q_2$, $Q_3$, and $\tau$.  Let $\overline{Y}^+$ denote the subgraph of $N$ consisting of the vertices and edges of $\overline{Y}$ plus the vertices and edges of every kite formed by a crossing between an edge of $G$ and an edge of $\overline{Y}$.
  
  We claim that, for each integer $i\ge 0$, $|V(Y^+)\cap V_i|\le 15$.  First observe that, since $Q_1,Q_2,Q_3$ are each vertical paths in $T$,  $\overline{Y}$ contains at most 3 vertices of $V_i$, each incident on at most two edges of $\overline{Y}$.  By \eqref{spar-distance}, any vertex $x\in V(\overline{Y}^+-\overline{Y})\cap V_i$, is incident on an edge $xy\in E(G)$ that crosses one of the at most six edges in $\overline{Y}$ having an endpoint in $V_i$.  These at most six edges have at most 12 endpoints.  Therefore $|V(\overline{Y}^+-\overline{Y})\cap V_i|\le 6\times 2=12$, so $|\overline{Y}^+\cap V_i|\le 12+3=15$.
  
  Finally, let $M$ and $M^+$ denote the subgraph of $G$ containing the edges and vertices of $Y$, respectively $Y^+$, and the edges and vertices of $F$.  The graph $M^+$ has some number of bounded faces, all contained in the interior of $F$. Some of the bounded faces of $M^+$ are kite faces. Let $F_1,\ldots,F_m$ be the non-kite bounded faces of $M^+$.  
  
  We claim that, for each $i\in\{1,\ldots,m\}$, the boundary of $F_i$ is a cycle in $G'$.  Otherwise, some edge $vw$ contributes to the boundary of $F_i$ but is crossed by an edge $xy\in E(G)$. Then, $vw\not\in E(F)$ since no edge of $F$ is crossed by any edge of $G$. Therefore $vw\in E(\overline{Y}^+)$ so $xy\in E(Y^+)$. But then the only faces of $M^+$ incident to $vw$ are kite faces.  In particular $vw$ can not be incident the non-kite face $F_i$.
  
  Note that $M$ is a Mercedes graph and that each of the faces $F_1,\ldots,F_m$ is contained in a single wedge of $M$.   Let $Y^+ = \overline{Y}^+-F$. Therefore, $V(F_i)$ can be partitioned into at most three sets $P_1'$, $P_2'$, and $P_3'$ where $P_1'\subset V(Y^+)$, $P_2'\subseteq P_a$, $P_3'\subseteq P_b$ for some $a,b\in\{1,2,3\}$, and $F_i[P_j']$ is a path, for each $j\in\{1,2,3\}$. 

  Finally, the subgraph $N_i$ of $G$ consisting of the edges and vertices of $G$ contained in $F_i$ or its interior does not contain one of the three vertices of $\tau$. Therefore, we can apply induction using the cycle $F_i$ and the partition $P_1',P_2',P_3'$ of $V(C_i)$ to obtain the desired $H$-partition and tree decomposition of $N_i$.
  
  The remainder of the proof finishes in the same way as the proof of Lemma~14 in \cite{dujmovic.joret.ea:planar}.  $P_1,\ldots,P_k$, and $V(Y^+)$ become elements of the $H$-partition.  Elements in each of the $H$-partitions of $N_1,\ldots,N_3$ that intersect $P_1,\ldots,P_k$, or $V(\overline{Y}^+-F)$ are discarded and all the resulting sets are combined to obtain an $H$-partition of $G$.  The desired tree decomposition of $G$ is obtained in exactly the same way as in the proof of Lemma~14 in \cite{dujmovic.joret.ea:planar}.
  
  The planarity of $H$ comes from two properties:
  \begin{enumerate}
    \item $G/\mathcal{P}$ and $G'/\mathcal{P}$ are isomorphic.  This follows immediately from the fact that, for each edge $xy\in E(G-G')$, $x,y\in S_a$ for some $a\in V(H)$.  Indeed, $S_a=Y^+_a$ where $\overline{Y}_a$ contains the edge $vw\in E(G')$ that crosses $xy$. 
    
    \item $G[\overline{Y}^+-F]$ is connected. To see why this is so, first observe that $\overline{Y}-F$ is connected, and then observe that every vertex of $\overline{Y}^+$ is either a vertex of $\overline{Y}$ or adjacent to a vertex of $\overline{Y}$.
  \end{enumerate}
  Since $G'$ is planar, this implies that $H=G'/\mathcal{P}$ is planar.\footnote{It is well-known and easy to see that any graph $\Delta'$ obtained by contracting an edge in a planar graph $\Delta$ is also planar.  Repeatedly applying this fact implies that $\Delta/\mathcal{P}$ is planar provided that $\Delta[P]$ is connected for every $P\in\mathcal{P}$.}
\end{proof}

Finally, we can complete the proof of \thmref{1-planar}.

\begin{proof}[Proof of \thmref{1-planar}]
  Using \lemref{induction}, the proof of \thmref{1-planar} is now straightforward. Given a 1-plane graph $G$, add edges to make it edge maximal so that it has an outer face $F=v_1v_2v_3$. Next, add a vertex $r$ adjacent to $v_1$, $v_2$, and $v_3$ to obtain an edge-maximal 1-plane graph $\overline{G}$ with one vertex $r$ of degree 3 on its outer face. 
  
  Let $G'$ be the plane graph obtained by removing one spar from each kite of $\overline{G}$ and let $T$ be a BFS tree of $G'$ rooted at $r$.  Now apply \lemref{induction} with $G=\overline{G}$, $G'$, $F$, and $P_i=\{v_i\}$ for each $i\in\{1,2,3\}$.  This gives an $H$-partition $\{S_x:x\in V(H)\}$ of $\overline{G}-\{r\}\supseteq G$ in which $H$ is planar and has treewidth at most 3.
  
  Use the layering $\mathcal{L}=\langle V_0',\ldots,V_h'\rangle$ where $V_i'=V_{2i}\cup V_{2i+1}$ for each $i\in\{0,\ldots,h\}$. That this is a layering of $G$ follows from \eqref{spar-distance}.  Since $|V_j\cap S_x|\le 15$ for every integer $i\ge 0$, $|V_i'\cap S_x|\le 30$ for every integer $i\ge 0$ and $x\in V(H)$.
\end{proof}

\section{$(g,k)$-Planar Graphs}
\seclabel{g-k-planar}

\begin{lem} \lemlabel{make-planar}
Let $G$ be a $(S,0)$-plane graph where $S$ is a surface with Euler genus $g$. 
%For every BFS layering $(V_0,V_1,\dots)$ of $G$,
%there is a set $Z\subseteq V(G)$ with at most $2g$ vertices in each layer $V_i$, such that $G-Z$ is planar. 
%Moreover, there is a connected planar graph $G^+$ containing $G-Z$ as a subgraph, 
%such that there is a BFS layering $(W_0,W_1,\dots)$ of $G^+$ and $W_{i} \cap V(G-Z) = V_i  \setminus Z$ for all $i\geq 0$. 
For every BFS spanning tree $T$ of $G$ rooted at some vertex $r\in V(G)$ with corresponding BFS layering $(V_0,V_1,\dots)$, 
there is a subgraph $Z\subseteq G$ with at most $2g$ vertices in each layer $V_i$, such that $G-V(Z)$ is planar. 
Moreover, there is a connected planar graph $G^*$ containing $G-V(Z)$ as a subgraph, and 
there is a BFS spanning tree $T^*$ of $G^*$ rooted at some vertex $r^*$ 
with corresponding BFS layering $(W_0,W_1,\dots)$ of $G^*$, 
such that  $W_{i} \cap V(G) \setminus V(Z) = V_i  \setminus V(Z)$ for all $i\geq 0$.
% , and
% $P \cap V(G) \setminus V(Z)$ is a vertical path in $T$ for every vertical path $P$ in $T^+$. 
\end{lem}


\begin{proof}[Proof of \thmref{g-k-planar}]
  Let $G$ be an $(S,k)$-plane graph where $S$ is a surface of Euler genus $g$.  Let $G^+$ be the $(S,0)$-plane graph obtained by adding a dummy vertex at each crossing in $G$.  Let $r$ be any vertex in $V(G)$ and let $T$ be BFS-spanning tree of $G^+$ rooted at $r$ and let $\mathcal{L}=\rangle V_0,ldots,V_h\rangle$ be the resulting layering of $G^+$.
    
  Apply \lemref{make-planar} to $G^{++}$ to obtain the set $Z\subseteq V(G^{++})$, the planar graph $G^*$, and the BFS spanning tree $T^*$ rooted at $r^*$.  For each edge $vw\in E(G)$, let $W_{vw}$ be the corresponding walk in $G^+$. The set $Z$ contains vertices in $V(G)$ as well as dummy vertices in $V(G^+-G)$. Create a new set $Z'\subseteq V(G)$ as
  \[
     Z' = \{ v : V(W_{vw})\cap Z\neq\emptyset \} \enspace .
  \]
  \note{PM}{We can certainly save a factor of 2 here because we only need one endpoint of each $vw$ that crosses $Z$ to take part in $Z'$.}
  Since $|Z\cap V_i| \le 2g$, the same argument used in the proof of \lemref{width-of-g-plus} shows that $|Z'\cap V_i|\le 2g\times 4\times (2k+1) = 16gk+8g$ for all $i\in\{1,\ldots,h\}$.  
  
  Furthermore, for every edge $vw\in E(G-Z')$, $\dist_{G^+-Z}(v,w)\le k+1$, since $W_{vw}\subseteq G^+-Z$.
  
  Next, observe that any plane embedding of $G^*\supseteq G^+-Z$ gives a $k$-plane embedding of $G-Z'$. Indeed, for every edge $vw\in E(G-Z')$, $G^+-Z$ contains a walk $W_{vw}$ that contains at most $k$ dummy vertices of $G^+-Z$.  Therefore, replacing edge edge $vw\in E(G-Z')$ with the corresponding walk in $G^*$ gives a $k$-plane embedding of $G-Z'$.
  
  Apply \thmref{k-planar} or (in the case $k=1$) \thmref{1-planar} to the $k$-plane embedding of $G-Z'$ to obtain a layered $H$-partition $(\mathcal{L}',\mathcal{P})$ of $G-Z'$.  Though not explicitly in the statement of either theorem, the proof of each theorem shows that it is possible to choose a vertex $r^*\in G^*$ so that each layer $V'_i\in \mathcal{L}'$ is contained in at most $k+1$ consecutive layers of $\mathcal{L}$.  Therefore, $|Z'\cap V_i'| \le (k+1)(16gk+8g) = 16gk^2 + 24gk + 8g$.
  
  We turn $\mathcal{P}$, the $H$-partition of $G-Z'$ into a partition $\mathcal{P}'=\mathcal{P}\cup \{Z'\}$.  Clearly, the treewidth of $H'=G/\mathcal{P'}$ is at most one more than the treewidth of $H=G/\mathcal{P}$.  Finally
  \[
      \max\{ |P\cap L| : P\in \mathcal{P}',\, L\in \mathcal{L}' \} \le
      \max\{ 16gk^2 + 24gk + 8g, 24k^2 + 36k + 12 \} \enspace .
  \]
  \note{PM}{All of the above still needs work...}
\end{proof}







% \section{Consequences}
% \seclabel{consequences}

\bibliographystyle{plainnat}
\bibliography{k-planar}

\end{document}
